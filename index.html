<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>生活智慧日历</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298, #1e3c72);
            background-size: 200% 200%;
            animation: animated-gradient 15s ease infinite;
            min-height: 100vh;
            overflow-x: hidden;
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        @keyframes animated-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .card-layer { position: absolute; width: 100%; height: 100%; transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; backface-visibility: hidden; opacity: 0; pointer-events: none; }
        .card-layer.active { transform: translateX(0) scale(1); opacity: 1; pointer-events: auto; }
        .card-layer.prev-out { transform: translateX(-50%) scale(0.9); opacity: 0; }
        .card-layer.next-out { transform: translateX(50%) scale(0.9); opacity: 0; }
        .card-layer.next-in { transform: translateX(50%) scale(0.9); }
        .card-layer.prev-in { transform: translateX(-50%) scale(0.9); }
        .main-card { backdrop-filter: blur(25px) saturate(180%); background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transition: all 0.3s ease; }
        .main-card:hover { transform: translateY(-8px); box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.3); }
        .nav-dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(255, 255, 255, 0.4); cursor: pointer; transition: all 0.3s ease; }
        .nav-dot.active { background: #ffffff; transform: scale(1.3); box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease; color: white; }
        .btn-primary:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 10px 20px rgba(118, 75, 162, 0.4); }
        .btn-secondary { background: rgba(230, 232, 240, 0.8); border: 1px solid rgba(0, 0, 0, 0.05); color: #334155; transition: all 0.3s ease;}
        .btn-secondary:hover { background: rgba(214, 219, 231, 0.9); transform: scale(1.05) translateY(-2px); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }
        .info-block { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .info-block:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .progress-circle { transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; cursor: pointer; }
        .modal-content { max-width: 90vw; max-height: 90vh; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border-radius: 1rem; }
        select:disabled { cursor: not-allowed; }
    </style>
</head>
<body class="flex flex-col items-center justify-center text-gray-800 p-4">
    <div class="text-center py-6">
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-2 flex items-center justify-center gap-x-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-.464 5.535a1 1 0 10-1.415-1.414 3 3 0 01-4.242 0 1 1 0 00-1.415 1.414 5 5 0 007.072 0z" clip-rule="evenodd" /></svg>
            生活智慧日历
        </h1>
        <p id="location-display" class="text-white/80 text-lg cursor-pointer hover:opacity-80 transition-opacity flex items-center justify-center gap-x-2" onclick="showLocationModal()">
            <span>正在获取位置...</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
            </svg>
        </p>
        <div class="text-xl font-mono text-white/90 mt-2" id="current-time"></div>
    </div>

    <div class="max-w-4xl mx-auto px-4 w-full">
        <div class="relative h-[650px] mb-8">
            </div>
        
        <div class="flex justify-center space-x-4 mb-8">
            </div>
        
        <div class="text-center text-white/80">
            <p class="text-sm"><span id="current-layer">第1层</span> / 共8层 <span class="mx-2">•</span> <span id="layer-title">今日概览</span></p>
        </div>
    </div>

    <div id="image-modal" class="modal-overlay" onclick="hideImageModal()">
        <img id="modal-image" src="" alt="放大的生态图片" class="modal-content" />
    </div>
    <div id="location-modal" class="modal-overlay" style="--tw-bg-opacity: 0.5;">
        <div class="main-card rounded-2xl p-6 md:p-8 w-full max-w-lg mx-4" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">选择您的位置</h2>
            <div class="space-y-4">
                <div>
                    <label for="country-select" class="block text-sm font-medium text-gray-700">国家</label>
                    <select id="country-select" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option>正在加载国家...</option>
                    </select>
                </div>
                <div>
                    <label for="state-select" class="block text-sm font-medium text-gray-700">州 / 省</label>
                    <select id="state-select" disabled class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm sm:text-sm">
                        <option>请先选择国家</option>
                    </select>
                </div>
                <div>
                    <label for="city-select" class="block text-sm font-medium text-gray-700">城市</label>
                    <select id="city-select" disabled class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm sm:text-sm">
                        <option>请先选择州/省</option>
                    </select>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-x-4">
                <button class="btn-secondary px-6 py-2 rounded-lg" onclick="hideLocationModal()">取消</button>
                <button id="confirm-location-btn" class="btn-primary px-6 py-2 rounded-lg shadow-lg" disabled>确定</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- 1. State and Constants ---
        let currentLayer = 1;
        const totalLayers = 8;
        const layerTitles = { 1: "今日概览", 2: "天气详情", 3: "月相详情", 4: "健康指数", 5: "生态观察", 6: "生活建议", 7: "金融动态 (股票)", 8: "加密货币" };
        let startX = 0;
        const OWM_API_KEY = 'f1f0de33939644fa3b20ea3e43ea4ac8';
        const IPGEO_API_KEY = 'ed130362fced4526a6f913e38886310c';
        const ALPHAVANTAGE_API_KEY = 'D6XEDCZR5KXTAYG6';
        const DEFAULT_CITY = 'Tawau';
        const DEFAULT_LAT = 4.24;
        const DEFAULT_LNG = 117.88;
        const DEFAULT_INAT_PLACE_ID = 119846;
        const moonPhaseTranslations = { "New Moon": "新月", "Waxing Crescent": "娥眉月", "First Quarter": "上弦月", "Waxing Gibbous": "盈凸月", "Full Moon": "满月", "Waning Gibbous": "亏凸月", "Last Quarter": "下弦月", "Waning Crescent": "残月" };
        let countries = [], states = [], cities = [];
        let globalWeatherData = null;
        let globalAstronomyData = null;

        // --- 2. API Fetching & Data Handling ---
        async function fetchCityName(lat, lon) { try { const response = await fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${OWM_API_KEY}`); if (!response.ok) throw new Error('City name fetch failed'); const data = await response.json(); if (data.length > 0) { return data[0].name; } return DEFAULT_CITY; } catch (error) { console.error(error); return DEFAULT_CITY; } }
        async function fetchWeatherData(lat, lon) { try { const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}&units=metric&lang=zh_cn`); if (!response.ok) throw new Error('Weather data fetch failed'); globalWeatherData = await response.json(); updateWeatherUI(globalWeatherData); updateDerivedHealthIndices(globalWeatherData); updateLifeAdvice(); } catch (error) { console.error(error); document.getElementById('details-desc').textContent = '天气加载失败。'; } }
        async function fetchAstronomyData(lat, lon) { try { const response = await fetch(`https://api.ipgeolocation.io/astronomy?apiKey=${IPGEO_API_KEY}&lat=${lat}&long=${lon}`); if (!response.ok) throw new Error('Astronomy data fetch failed'); globalAstronomyData = await response.json(); updateAstronomyUI(globalAstronomyData); updateMoonImpact(); updateLifeAdvice(); } catch (error) { console.error(error); document.getElementById('overview-moon-phase').textContent = '加载失败'; } }
        async function fetchAirPollutionData(lat, lon) { try { const response = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}`); if (!response.ok) throw new Error('Air pollution data fetch failed'); const data = await response.json(); updateAirPollutionUI(data); } catch (error) { console.error(error); const aqiItem = document.getElementById('health-item-aqi'); if (aqiItem) aqiItem.dataset.value = "0"; } }
        async function fetchEcologyData(placeId) { try { const response = await fetch(`https://api.inaturalist.org/v1/observations?place_id=${placeId}&photos=true&per_page=5&order=desc&order_by=observed_on`); if (!response.ok) throw new Error('iNaturalist API fetch failed'); const data = await response.json(); updateEcologyUI(data); } catch (error) { console.error('Ecology data fetch failed', error); displayEcologyFallback(); } }
        async function fetchStockData() { /* ... unchanged ... */ }
        async function fetchCryptoData() { /* ... unchanged ... */ }

        // --- 3. UI Update Functions ---
        function updateWeatherUI(data) { /* ... unchanged ... */ }
        function updateAstronomyUI(data) { /* ... unchanged ... */ }
        function updateAirPollutionUI(data) { /* ... unchanged ... */ }
        function updateDerivedHealthIndices(data) { /* ... unchanged ... */ }
        function updateEcologyUI(data) { /* ... unchanged ... */ }
        function displayEcologyFallback() { /* ... unchanged ... */ }
        function updateStockUI(item, quote) { /* ... unchanged ... */ }
        function updateCryptoUI(cryptoInfo, quote) { /* ... unchanged ... */ }
        function displayFinanceError(item, listId, message) { /* ... unchanged ... */ }
        
        function updateMoonImpact() {
            if (!globalAstronomyData) return;
            const now = new Date();
            const hour = now.getHours();
            const moonImpactList = document.getElementById('moon-ecology-impact');
            if (moonImpactList) {
                const phaseName = (document.getElementById('moon-phase-name').textContent || "").trim();
                let tips = [];
                if (phaseName === "满月" || phaseName === "盈凸月") {
                    tips.push(`<li>${hour >= 18 ? '夜行生物活跃，适合生态观察。' : '傍晚后夜行生物将更活跃。'}</li>`, `<li>潮汐力强，${hour >= 14 ? '下午适合海钓。' : '下午是海钓的好时机。'}</li>`);
                } else {
                    tips.push("<li>生物节律平稳，适合常规活动。</li>", "<li>潮汐平缓，近海活动相对安全。</li>");
                }
                moonImpactList.innerHTML = tips.join('');
            }
        }

        function updateLifeAdvice() {
            if (!globalWeatherData || !globalAstronomyData) return;
            const now = new Date();
            const hour = now.getHours();
            const weather = globalWeatherData.list[0];
            const temp = weather.main.temp;
            const humidity = weather.main.humidity;
            const phaseName = (document.getElementById('moon-phase-name').textContent || "").trim();
            
            const dietAdvice = document.getElementById('diet-advice');
            const outdoorAdvice = document.getElementById('outdoor-advice');
            const healthAdvice = document.getElementById('health-advice');

            if(dietAdvice) dietAdvice.innerHTML = `<li>**清凉饮食**: 多喝${humidity > 75 ? '冬瓜汤' : '椰子水'}，解暑防湿。</li><li>**食物保鲜**: 高温${temp > 30 ? '易变质' : '正常'}，注意冷藏。</li>`;
            if(outdoorAdvice) outdoorAdvice.innerHTML = `<li>**最佳时间**: ${hour >= 14 && hour < 17 ? '当前时段炎热，建议傍晚' : '适合'}散步。</li><li>**必备物品**: ${temp > 30 ? '太阳帽、防晒霜' : '轻便衣物'}、饮用水。</li>`;
            if(healthAdvice) healthAdvice.innerHTML = `<li>晚夏湿热，${phaseName === '盈凸月' ? '盈凸月养阴' : '月相平稳'}。饮食清淡。</li><li>下午2点后${hour >= 14 ? '避免' : '适度'}活动，午休养心。</li><li>穴位按摩：合谷穴清热，太冲穴疏肝。</li>`;
        }

        // --- 4. Helper & Modal Functions ---
        /* All helper and modal functions are unchanged */

        // --- 5. Core UI Interaction ---
        /* All core UI functions are unchanged */

        // --- 6. Page Load & Geolocation ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeWithLocation();
            setInterval(updateTime, 1000);
            updateTime();
            triggerEntryAnimations(document.getElementById('layer-1'));
            document.addEventListener('keydown', e => { /* ... */ });
            document.addEventListener('touchstart', e => { /* ... */ });
            document.addEventListener('touchend', e => { /* ... */ });
            // Location Modal Listeners
            document.getElementById('country-select').addEventListener('change', e => { /* ... */ });
            document.getElementById('state-select').addEventListener('change', e => { /* ... */ });
            document.getElementById('city-select').addEventListener('change', e => { /* ... */ });
            document.getElementById('confirm-location-btn').addEventListener('click', () => { /* ... */ });
        });

        function initializeWithLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const cityName = await fetchCityName(lat, lon);
                        document.getElementById('location-display').querySelector('span').textContent = cityName;
                        fetchAllData(lat, lon, DEFAULT_INAT_PLACE_ID);
                    },
                    () => {
                        console.log("Geolocation permission denied. Using default location.");
                        document.getElementById('location-display').querySelector('span').textContent = `马来西亚 · ${DEFAULT_CITY}`;
                        fetchAllData(DEFAULT_LAT, DEFAULT_LNG, DEFAULT_INAT_PLACE_ID);
                    }
                );
            } else {
                console.log("Geolocation is not supported. Using default location.");
                document.getElementById('location-display').querySelector('span').textContent = `马来西亚 · ${DEFAULT_CITY}`;
                fetchAllData(DEFAULT_LAT, DEFAULT_LNG, DEFAULT_INAT_PLACE_ID);
            }
        }

        function fetchAllData(lat, lon, placeId) {
            fetchWeatherData(lat, lon);
            fetchAstronomyData(lat, lon);
            fetchAirPollutionData(lat, lon);
            fetchEcologyData(placeId);
            fetchStockData();
            fetchCryptoData();
        }
    </script>
</body>
</html>
