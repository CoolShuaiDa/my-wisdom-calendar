<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>生活智慧日历</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298, #1e3c72);
            background-size: 200% 200%;
            animation: animated-gradient 15s ease infinite;
            min-height: 100vh;
            overflow-x: hidden;
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        @keyframes animated-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .card-layer { position: absolute; width: 100%; height: 100%; transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; backface-visibility: hidden; opacity: 0; pointer-events: none; }
        .card-layer.active { transform: translateX(0) scale(1); opacity: 1; pointer-events: auto; }
        .card-layer.prev-out { transform: translateX(-50%) scale(0.9); opacity: 0; }
        .card-layer.next-out { transform: translateX(50%) scale(0.9); opacity: 0; }
        .card-layer.next-in { transform: translateX(50%) scale(0.9); }
        .card-layer.prev-in { transform: translateX(-50%) scale(0.9); }
        .main-card { backdrop-filter: blur(25px) saturate(180%); background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transition: all 0.3s ease; }
        .main-card:hover { transform: translateY(-8px); box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.3); }
        .nav-dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(255, 255, 255, 0.4); cursor: pointer; transition: all 0.3s ease; }
        .nav-dot.active { background: #ffffff; transform: scale(1.3); box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease; color: white; }
        .btn-primary:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 10px 20px rgba(118, 75, 162, 0.4); }
        .btn-secondary { background: rgba(230, 232, 240, 0.8); border: 1px solid rgba(0, 0, 0, 0.05); color: #334155; transition: all 0.3s ease;}
        .btn-secondary:hover { background: rgba(214, 219, 231, 0.9); transform: scale(1.05) translateY(-2px); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }
        .info-block { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .info-block:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .progress-circle { transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; cursor: pointer; }
        .modal-content { max-width: 90vw; max-height: 90vh; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border-radius: 1rem; }
        select:disabled { cursor: not-allowed; }
    </style>
</head>
<body class="flex flex-col items-center justify-center text-gray-800 p-4">
    <div class="text-center py-6">
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-2 flex items-center justify-center gap-x-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-.464 5.535a1 1 0 10-1.415-1.414 3 3 0 01-4.242 0 1 1 0 00-1.415 1.414 5 5 0 007.072 0z" clip-rule="evenodd" /></svg>
            生活智慧日历
        </h1>
        <p id="location-display" class="text-white/80 text-lg cursor-pointer hover:opacity-80 transition-opacity flex items-center justify-center gap-x-2" onclick="showLocationModal()">
            <span>正在获取位置...</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
            </svg>
        </p>
        <div class="text-xl font-mono text-white/90 mt-2" id="current-time"></div>
    </div>

    <div class="max-w-4xl mx-auto px-4 w-full">
        <div class="relative h-[650px] mb-8">
            
            <div class="card-layer active" id="layer-1">
                <div class="main-card rounded-3xl p-6 md:p-8 h-full flex flex-col">
                    <div class="text-center mb-6 fade-in-up" data-anim="true">
                        <h2 class="text-3xl font-bold text-gray-800 mb-2">今日概览</h2>
                        <p class="text-gray-500 text-lg" id="overview-date">...</p>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 flex-1">
                        <div class="info-block text-center p-4 bg-gradient-to-br from-orange-100 to-yellow-100 rounded-2xl fade-in-up" data-anim="true" style="animation-delay: 0.1s;">
                            <div class="text-orange-500 mx-auto mb-2 text-4xl" id="overview-weather-icon">☀️</div>
                            <h3 class="font-bold text-gray-800">天气</h3>
                            <p class="text-xl font-bold text-orange-600" id="overview-temp">--°C</p>
                        </div>
                        <div class="info-block text-center p-4 bg-gradient-to-br from-purple-100 to-blue-100 rounded-2xl fade-in-up" data-anim="true" style="animation-delay: 0.2s;">
                            <div class="text-purple-500 mx-auto mb-2 text-4xl" id="overview-moon-icon">🌙</div>
                            <h3 class="font-bold text-gray-800">月相</h3>
                            <p class="text-xl font-bold text-purple-600" id="overview-moon-phase">...</p>
                        </div>
                        <div class="info-block text-center p-4 bg-gradient-to-br from-green-100 to-teal-100 rounded-2xl fade-in-up" data-anim="true" style="animation-delay: 0.3s;">
                            <div class="text-green-500 mx-auto mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L9 9.61l-1.447 1.447a1 1 0 00-1.394 1.432l5.5 5.5a1 1 0 001.432-1.394L11.39 12.5l5.216-2.234a1 1 0 000-1.84l-7-3zM9 13.41l-2.43-2.43 5.48-2.35 2.43 2.43-5.48 2.35z" /></svg></div>
                            <h3 class="font-bold text-gray-800">生态</h3>
                            <p class="text-xl font-bold text-green-600" id="overview-ecology-status">活跃期</p>
                        </div>
                        <div class="info-block text-center p-4 bg-gradient-to-br from-pink-100 to-red-100 rounded-2xl fade-in-up" data-anim="true" style="animation-delay: 0.4s;">
                            <div class="text-pink-500 mx-auto mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg></div>
                            <h3 class="font-bold text-gray-800">健康</h3>
                            <p class="text-xl font-bold text-pink-600" id="overview-health-status">...</p>
                        </div>
                        <div class="info-block text-center p-4 bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl fade-in-up" data-anim="true" style="animation-delay: 0.5s;">
                            <div class="text-yellow-500 mx-auto mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg></div>
                            <h3 class="font-bold text-gray-800">作息</h3>
                            <p class="text-xl font-bold text-yellow-600">规律</p>
                        </div>
                        <div class="info-block text-center p-4 bg-gradient-to-br from-blue-100 to-indigo-100 rounded-2xl fade-in-up" data-anim="true" style="animation-delay: 0.6s;">
                            <div class="text-blue-500 mx-auto mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg></div>
                            <h3 class="font-bold text-gray-800">提醒</h3>
                            <p class="text-xl font-bold text-blue-600" id="overview-advice">...</p>
                        </div>
                    </div>
                    <div class="text-center mt-8 fade-in-up" data-anim="true" style="animation-delay: 0.7s;">
                        <button class="btn-primary px-8 py-3 rounded-xl font-semibold text-lg shadow-lg" onclick="nextLayer()">查看详细信息 &rarr;</button>
                    </div>
                </div>
            </div>

            <div class="card-layer" id="layer-2">
                <div class="main-card rounded-3xl p-6 md:p-8 h-full flex flex-col">
                    <div class="flex items-center justify-between mb-6 fade-in-up flex-shrink-0" data-anim="true">
                        <h2 class="text-3xl font-bold text-gray-800">天气详情</h2>
                        <div class="bg-orange-400 p-3 rounded-2xl text-white shadow-lg text-4xl" id="details-weather-icon">☀️</div>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        <div class="grid md:grid-cols-2 gap-8 mb-6 fade-in-up" data-anim="true" style="animation-delay: 0.1s;">
                            <div>
                                <div class="text-center mb-6">
                                    <div class="text-6xl font-bold text-orange-600" id="details-temp">--°C</div>
                                    <p class="text-xl text-gray-500" id="details-feels-like">体感 --°C</p>
                                    <p class="text-lg text-gray-800 capitalize" id="details-desc">正在加载天气...</p>
                                </div>
                                <div class="space-y-4 text-sm">
                                    <div class="flex justify-between items-center"><span class="text-gray-600">湿度</span><span class="font-bold" id="details-humidity">-- %</span></div>
                                    <div class="flex justify-between items-center"><span class="text-gray-600">风速</span><span class="font-bold" id="details-wind">-- m/s</span></div>
                                    <div class="flex justify-between items-center"><span class="text-gray-600">气压</span><span class="font-bold" id="details-pressure">-- hPa</span></div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 mb-4">未来24小时预报</h3>
                                <div class="bg-orange-50 p-4 rounded-2xl" id="weather-chart-container"><p class="text-center text-gray-500">正在加载预报...</p></div>
                            </div>
                        </div>
                        <div class="bg-red-50 p-4 rounded-2xl fade-in-up" data-anim="true" style="animation-delay: 0.2s;">
                            <h3 class="font-bold text-red-800 mb-3 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.214 2.852-1.214 3.488 0l6.093 11.624c.636 1.214-.472 2.777-1.744 2.777H3.908c-1.272 0-2.38-1.563-1.744-2.777L8.257 3.099zM10 6a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 6zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>天气提醒</h3>
                            <div id="weather-advice-list" class="text-red-700 text-sm">正在根据实时天气生成建议...</div>
                        </div>
                    </div>
                    <div class="flex justify-center items-center gap-4 mt-6 flex-shrink-0 fade-in-up" data-anim="true" style="animation-delay: 0.3s;">
                        <button class="btn-secondary px-8 py-3 rounded-xl font-semibold text-lg" onclick="prevLayer()">&larr; 上一层</button>
                        <button class="btn-primary px-8 py-3 rounded-xl font-semibold text-lg shadow-lg" onclick="nextLayer()">下一层 &rarr;</button>
                    </div>
                </div>
            </div>
            
            <div class="card-layer" id="layer-3">
                 <div class="main-card rounded-3xl p-6 md:p-8 h-full flex flex-col">
                    <div class="flex items-center justify-between mb-6 fade-in-up flex-shrink-0" data-anim="true">
                        <h2 class="text-3xl font-bold text-gray-800">月相详情</h2>
                        <div class="bg-indigo-500 p-3 rounded-2xl text-white shadow-lg text-4xl" id="details-moon-icon">🌙</div>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        <div class="grid md:grid-cols-2 gap-8 mb-6 fade-in-up" data-anim="true" style="animation-delay: 0.1s;">
                            <div class="text-center">
                                <div class="relative w-40 h-40 mx-auto mb-4 text-8xl flex items-center justify-center" id="moon-visual">...</div>
                                <div class="bg-indigo-50 p-4 rounded-xl">
                                    <p class="text-2xl font-bold text-indigo-600" id="moon-phase-name">...</p>
                                    <p class="text-gray-500" id="moon-illumination">-- % 被照亮</p>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <h3 class="text-xl font-bold text-gray-800 mb-2">关键时间</h3>
                                <div class="flex justify-between items-center p-3 bg-blue-50 rounded-xl"><span class="flex items-center gap-2">🌅 日出</span> <span class="font-bold text-blue-600" id="sunrise-time">--:--</span></div>
                                <div class="flex justify-between items-center p-3 bg-orange-50 rounded-xl"><span class="flex items-center gap-2">🌇 日落</span> <span class="font-bold text-orange-600" id="sunset-time">--:--</span></div>
                                <div class="flex justify-between items-center p-3 bg-indigo-50 rounded-xl"><span class="flex items-center gap-2">🌔 月出</span> <span class="font-bold text-indigo-600" id="moonrise-time">--:--</span></div>
                                <div class="flex justify-between items-center p-3 bg-gray-100 rounded-xl"><span class="flex items-center gap-2">🌘 月落</span> <span class="font-bold text-gray-600" id="moonset-time">--:--</span></div>
                            </div>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-2xl fade-in-up" data-anim="true" style="animation-delay: 0.2s;">
                            <h3 class="font-bold text-purple-800 mb-3 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M11.983 1.904a1 1 0 00-1.966 0l-1.34 4.143a1 1 0 01-.95.69h-4.354a1 1 0 00-.75 1.68l3.522 2.56-1.34 4.143a1 1 0 001.512 1.103l3.522-2.56 3.522 2.56a1 1 0 001.512-1.102l-1.34-4.143 3.522-2.56a1 1 0 00-.75-1.68h-4.354a1 1 0 01-.95-.69L11.983 1.904z" /></svg>月相对生态的影响</h3>
                            <ul class="text-sm text-purple-700 space-y-1 list-disc list-inside" id="moon-ecology-impact">
                               <li>正在根据当前时间和月相生成建议...</li>
                            </ul>
                        </div>
                    </div>
                    <div class="flex justify-center items-center gap-4 mt-6 flex-shrink-0 fade-in-up" data-anim="true" style="animation-delay: 0.3s;">
                        <button class="btn-secondary px-8 py-3 rounded-xl font-semibold text-lg" onclick="prevLayer()">&larr; 上一层</button>
                        <button class="btn-primary px-8 py-3 rounded-xl font-semibold text-lg shadow-lg" onclick="nextLayer()">下一层 &rarr;</button>
                    </div>
                </div>
            </div>

            <div class="card-layer" id="layer-4">
                 <div class="main-card rounded-3xl p-6 md:p-8 h-full flex flex-col">
                    <div class="flex items-center justify-between mb-6 fade-in-up flex-shrink-0" data-anim="true">
                        <h2 class="text-3xl font-bold text-gray-800">健康指数</h2>
                        <div class="bg-pink-500 p-3 rounded-2xl text-white shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center fade-in-up" data-anim="true" style="animation-delay: 0.1s;">
                            <div class="health-item" id="health-item-exercise" data-value="0" data-color="#10b981">
                                <div class="relative w-24 h-24 mx-auto mb-2">
                                    <svg class="w-full h-full transform -rotate-90"><circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/><circle class="progress-circle" cx="48" cy="48" r="40" stroke="#10b981" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="251.2"/></svg>
                                    <div class="absolute inset-0 flex items-center justify-center"><span class="text-xl font-bold text-green-600">--%</span></div>
                                </div>
                                <h3 class="font-bold text-gray-700 text-sm">运动适宜</h3>
                            </div>
                             <div class="health-item" id="health-item-uv" data-value="0" data-color="#f59e0b">
                                <div class="relative w-24 h-24 mx-auto mb-2">
                                    <svg class="w-full h-full transform -rotate-90"><circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/><circle class="progress-circle" cx="48" cy="48" r="40" stroke="#f59e0b" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="251.2"/></svg>
                                    <div class="absolute inset-0 flex items-center justify-center"><span class="text-xl font-bold text-yellow-500">--%</span></div>
                                </div>
                                <h3 class="font-bold text-gray-700 text-sm">紫外线指数</h3>
                            </div>
                             <div class="health-item" id="health-item-aqi" data-value="0" data-color="#06b6d4">
                                <div class="relative w-24 h-24 mx-auto mb-2">
                                    <svg class="w-full h-full transform -rotate-90"><circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/><circle class="progress-circle" cx="48" cy="48" r="40" stroke="#06b6d4" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="251.2"/></svg>
                                    <div class="absolute inset-0 flex items-center justify-center"><span class="text-xl font-bold text-cyan-600">--%</span></div>
                                </div>
                                <h3 class="font-bold text-gray-700 text-sm">空气质量</h3>
                            </div>
                             <div class="health-item" id="health-item-heat" data-value="0" data-color="#ef4444">
                                <div class="relative w-24 h-24 mx-auto mb-2">
                                    <svg class="w-full h-full transform -rotate-90"><circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="none"/><circle class="progress-circle" cx="48" cy="48" r="40" stroke="#ef4444" stroke-width="8" fill="none" stroke-linecap="round" stroke-dasharray="251.2" stroke-dashoffset="251.2"/></svg>
                                    <div class="absolute inset-0 flex items-center justify-center"><span class="text-xl font-bold text-red-500">--%</span></div>
                                </div>
                                <h3 class="font-bold text-gray-700 text-sm">防暑指数</h3>
                            </div>
                        </div>
                        <div class="bg-pink-50 p-4 rounded-2xl fade-in-up" data-anim="true" style="animation-delay: 0.2s;">
                             <h3 class="font-bold text-pink-800 mb-3 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-1.707 1.707A1 1 0 003 15v1a1 1 0 001 1h12a1 1 0 001-1v-1a1 1 0 00-.293-.707L16 11.586V8a6 6 0 00-6-6zM8.05 16.95A.5.5 0 018 17h4a.5.5 0 01-.05.05A3.001 3.001 0 018.05 16.95z" /></svg>健康提醒</h3>
                             <div class="grid md:grid-cols-2 gap-4 text-sm text-pink-700" id="health-advice-list">
                                <p>正在根据实时数据生成健康建议...</p>
                             </div>
                        </div>
                    </div>
                    <div class="flex justify-center items-center gap-4 mt-6 flex-shrink-0 fade-in-up" data-anim="true" style="animation-delay: 0.3s;">
                        <button class="btn-secondary px-8 py-3 rounded-xl font-semibold text-lg" onclick="prevLayer()">&larr; 上一层</button>
                        <button class="btn-primary px-8 py-3 rounded-xl font-semibold text-lg shadow-lg" onclick="nextLayer()">下一层 &rarr;</button>
                    </div>
                </div>
            </div>

            <div class="card-layer" id="layer-5">
                 <div class="main-card rounded-3xl p-6 md:p-8 h-full flex flex-col">
                    <div class="flex items-center justify-between mb-6 fade-in-up flex-shrink-0" data-anim="true">
                        <h2 class="text-3xl font-bold text-gray-800">生态观察</h2>
                        <div class="bg-green-500 p-3 rounded-2xl text-white shadow-lg">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                        </div>
                    </div>
                    <div class="space-y-4 flex-1 overflow-y-auto fade-in-up" data-anim="true" style="animation-delay: 0.1s;" id="ecology-list">
                        <div class="text-center text-gray-500">正在从iNaturalist获取本地生态信息...</div>
                    </div>
                    <div class="flex justify-center items-center gap-4 mt-6 flex-shrink-0 fade-in-up" data-anim="true" style="animation-delay: 0.2s;">
                        <button class="btn-secondary px-8 py-3 rounded-xl font-semibold text-lg" onclick="prevLayer()">&larr; 上一层</button>
                        <button class="btn-primary px-8 py-3 rounded-xl font-semibold text-lg shadow-lg" onclick="nextLayer()">下一层 &rarr;</button>
                    </div>
                </div>
            </div>
            
            <div class="card-layer" id="layer-6">
                <div class="main-card rounded-3xl p-6 md:p-8 h-full flex flex-col">
                     <div class="flex items-center justify-between mb-6 fade-in-up flex-shrink-0" data-anim="true">
                        <h2 class="text-3xl font-bold text-gray-800">生活建议</h2>
                        <div class="bg-cyan-500 p-3 rounded-2xl text-white shadow-lg">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>
                        </div>
                    </div>
                    <div class="space-y-4 flex-1 overflow-y-auto fade-in-up" data-anim="true" style="animation-delay: 0.1s;">
                        <div class="bg-cyan-50 p-4 rounded-xl">
                            <h3 class="font-bold text-cyan-800 mb-2">居家生活</h3>
                            <ul class="text-sm text-cyan-700 space-y-1 list-disc list-inside">
                                <li>**防潮通风**: 早晚开窗，利用空调除湿，防止衣物发霉。</li>
                                <li>**驱蚊防虫**: 检查纱窗，使用天然驱蚊剂，清理积水。</li>
                            </ul>
                        </div>
                        <div class="bg-teal-50 p-4 rounded-xl">
                            <h3 class="font-bold text-teal-800 mb-2">饮食养生</h3>
                            <ul class="text-sm text-teal-700 space-y-1 list-disc list-inside" id="diet-advice">
                                <li>正在根据天气生成建议...</li>
                            </ul>
                        </div>
                         <div class="bg-amber-50 p-4 rounded-xl">
                            <h3 class="font-bold text-amber-800 mb-2">户外活动</h3>
                            <ul class="text-sm text-amber-700 space-y-1 list-disc list-inside" id="outdoor-advice">
                                 <li>正在根据天气生成建议...</li>
                            </ul>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-xl">
                            <h3 class="font-bold text-indigo-800 mb-2">中医养生提示</h3>
                            <ul class="text-sm text-indigo-700 space-y-1 list-disc list-inside" id="health-advice">
                                 <li>正在根据节气与数据生成建议...</li>
                            </ul>
                        </div>
                    </div>
                    <div class="flex justify-center items-center gap-4 mt-6 flex-shrink-0 fade-in-up" data-anim="true" style="animation-delay: 0.2s;">
                        <button class="btn-secondary px-8 py-3 rounded-xl font-semibold text-lg" onclick="prevLayer()">&larr; 上一层</button>
                        <button class="btn-primary px-8 py-3 rounded-xl font-semibold text-lg shadow-lg" onclick="nextLayer()">下一层 &rarr;</button>
                    </div>
                </div>
            </div>

            <div class="card-layer" id="layer-7">
                <div class="main-card rounded-3xl p-6 md:p-8 h-full flex flex-col">
                   <div class="flex items-center justify-between mb-6 fade-in-up flex-shrink-0" data-anim="true">
                       <h2 class="text-3xl font-bold text-gray-800">金融动态 (股票)</h2>
                       <div class="bg-yellow-500 p-3 rounded-2xl text-white shadow-lg">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg>
                       </div>
                   </div>
                   <div class="flex-1 overflow-y-auto space-y-4 fade-in-up" data-anim="true" style="animation-delay: 0.1s;" id="finance-stock-list">
                       <p class="text-center text-gray-500">正在加载股票数据...</p>
                   </div>
                   <div class="flex justify-center items-center gap-4 mt-6 flex-shrink-0 fade-in-up" data-anim="true" style="animation-delay: 0.2s;">
                       <button class="btn-secondary px-8 py-3 rounded-xl font-semibold text-lg" onclick="prevLayer()">&larr; 上一层</button>
                       <button class="btn-primary px-8 py-3 rounded-xl font-semibold text-lg shadow-lg" onclick="nextLayer()">加密货币 &rarr;</button>
                   </div>
               </div>
            </div>

            <div class="card-layer" id="layer-8">
                <div class="main-card rounded-3xl p-6 md:p-8 h-full flex flex-col">
                    <div class="flex items-center justify-between mb-6 fade-in-up flex-shrink-0" data-anim="true">
                       <h2 class="text-3xl font-bold text-gray-800">加密货币</h2>
                       <div class="bg-purple-500 p-3 rounded-2xl text-white shadow-lg">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 10v-1m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3-.895 3-2-1.343-2-3-2m0 10c-1.11 0-2.08-.402-2.599-1M12 16V5.5A2.5 2.5 0 009.5 3h-1A2.5 2.5 0 006 5.5V16m12-2.5a2.5 2.5 0 01-2.5 2.5h-1a2.5 2.5 0 01-2.5-2.5V5.5A2.5 2.5 0 0113.5 3h1a2.5 2.5 0 012.5 2.5V13.5z" /></svg>
                       </div>
                   </div>
                   <div class="flex-1 overflow-y-auto space-y-4 fade-in-up" data-anim="true" style="animation-delay: 0.1s;" id="crypto-list">
                       <p class="text-center text-gray-500">正在加载加密货币数据...</p>
                   </div>
                   <div class="flex justify-center items-center gap-4 mt-6 flex-shrink-0 fade-in-up" data-anim="true" style="animation-delay: 0.2s;">
                       <button class="btn-secondary px-8 py-3 rounded-xl font-semibold text-lg" onclick="prevLayer()">&larr; 上一层</button>
                       <button class="btn-primary px-8 py-3 rounded-xl font-semibold text-lg shadow-lg" onclick="goToLayer(1)">返回概览 ↻</button>
                   </div>
               </div>
            </div>
        </div>
        
        <div class="flex justify-center space-x-4 mb-8">
            <div class="nav-dot active" data-layer="1" onclick="goToLayer(1)"></div>
            <div class="nav-dot" data-layer="2" onclick="goToLayer(2)"></div>
            <div class="nav-dot" data-layer="3" onclick="goToLayer(3)"></div>
            <div class="nav-dot" data-layer="4" onclick="goToLayer(4)"></div>
            <div class="nav-dot" data-layer="5" onclick="goToLayer(5)"></div>
            <div class="nav-dot" data-layer="6" onclick="goToLayer(6)"></div>
            <div class="nav-dot" data-layer="7" onclick="goToLayer(7)"></div>
            <div class="nav-dot" data-layer="8" onclick="goToLayer(8)"></div>
        </div>
        
        <div class="text-center text-white/80">
            <p class="text-sm"><span id="current-layer">第1层</span> / 共8层 <span class="mx-2">•</span> <span id="layer-title">今日概览</span></p>
        </div>
    </div>

    <div id="image-modal" class="modal-overlay" onclick="hideImageModal()">
        <img id="modal-image" src="" alt="放大的生态图片" class="modal-content" />
    </div>
    <div id="location-modal" class="modal-overlay" style="--tw-bg-opacity: 0.5;">
        <div class="main-card rounded-2xl p-6 md:p-8 w-full max-w-lg mx-4" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">选择您的位置</h2>
            <div class="space-y-4">
                <div>
                    <label for="country-select" class="block text-sm font-medium text-gray-700">国家</label>
                    <select id="country-select" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option>正在加载国家...</option>
                    </select>
                </div>
                <div>
                    <label for="state-select" class="block text-sm font-medium text-gray-700">州 / 省</label>
                    <select id="state-select" disabled class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm sm:text-sm">
                        <option>请先选择国家</option>
                    </select>
                </div>
                <div>
                    <label for="city-select" class="block text-sm font-medium text-gray-700">城市</label>
                    <select id="city-select" disabled class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm sm:text-sm">
                        <option>请先选择州/省</option>
                    </select>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-x-4">
                <button class="btn-secondary px-6 py-2 rounded-lg" onclick="hideLocationModal()">取消</button>
                <button id="confirm-location-btn" class="btn-primary px-6 py-2 rounded-lg shadow-lg" disabled>确定</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- 1. State and Constants ---
        let currentLayer = 1;
        const totalLayers = 8;
        const layerTitles = { 1: "今日概览", 2: "天气详情", 3: "月相详情", 4: "健康指数", 5: "生态观察", 6: "生活建议", 7: "金融动态 (股票)", 8: "加密货币" };
        let startX = 0;
        const OWM_API_KEY = 'f1f0de33939644fa3b20ea3e43ea4ac8';
        const IPGEO_API_KEY = 'ed130362fced4526a6f913e38886310c';
        const ALPHAVANTAGE_API_KEY = 'D6XEDCZR5KXTAYG6';
        const DEFAULT_CITY = 'Tawau';
        const DEFAULT_LAT = 4.24;
        const DEFAULT_LNG = 117.88;
        const DEFAULT_INAT_PLACE_ID = 119846;
        const moonPhaseTranslations = { "New Moon": "新月", "Waxing Crescent": "娥眉月", "First Quarter": "上弦月", "Waxing Gibbous": "盈凸月", "Full Moon": "满月", "Waning Gibbous": "亏凸月", "Last Quarter": "下弦月", "Waning Crescent": "残月" };
        let countries = [], states = [], cities = [];
        let globalWeatherData = null;
        let globalAstronomyData = null;

        // --- 2. API Fetching ---
        // 首先，在脚本的顶部（常量区）初始化Supabase客户端
const SUPABASE_URL = 'https://exmfareyaysyvicxyekc.supabase.co';      // 从您的Supabase后台API设置中获取
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4bWZhcmV5YXlzeXZpY3h5ZWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NDQ4NDUsImV4cCI6MjA3MDAyMDg0NX0.9Pvq56Yee_6TbWjfqrtWb1crIupumw_F8Ts6gLSZMnM'; // 从您的Supabase后台API设置中获取
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 删除旧的 let countries = [], states = [], cities = []; 变量

// 重写获取国家、州、城市的函数
async function populateCountries() {
    const countrySelect = document.getElementById('country-select');
    countrySelect.innerHTML = '<option value="">-- 选择国家 --</option>';

    const { data: countries, error } = await supabase.from('countries').select('name, iso2').order('name');

    if (error) {
        console.error('Error fetching countries:', error);
        return;
    }

    countries.forEach(country => {
        const option = document.createElement('option');
        option.value = country.iso2;
        option.textContent = country.name;
        countrySelect.appendChild(option);
    });
}

async function populateStates(countryCode) {
    const stateSelect = document.getElementById('state-select');
    stateSelect.innerHTML = '<option>正在加载州/省...</option>';
    stateSelect.disabled = true;

    const { data: states, error } = await supabase.from('states').select('name, id').eq('country_code', countryCode).order('name');

    if (error) {
        console.error('Error fetching states:', error);
        return;
    }

    stateSelect.innerHTML = '<option value="">-- 选择州/省 --</option>';
    states.forEach(state => {
        const option = document.createElement('option');
        option.value = state.id; // 使用 state id 作为 value
        option.textContent = state.name;
        stateSelect.appendChild(option);
    });
    stateSelect.disabled = false;
}

async function populateCities(stateId) {
    const citySelect = document.getElementById('city-select');
    citySelect.innerHTML = '<option>正在加载城市...</option>';
    citySelect.disabled = true;

    const { data: cities, error } = await supabase.from('cities').select('name, latitude, longitude').eq('state_id', stateId).order('name');

    if (error) {
        console.error('Error fetching cities:', error);
        return;
    }

    citySelect.innerHTML = '<option value="">-- 选择城市 --</option>';
    cities.forEach(city => {
        const option = document.createElement('option');
        option.value = city.name;
        option.dataset.lat = city.latitude;
        option.dataset.lon = city.longitude;
        option.textContent = city.name;
        citySelect.appendChild(option);
    });
    citySelect.disabled = false;
}

// 在 showLocationModal 中，不再需要检查 countries.length
async function showLocationModal() {
    const modal = document.getElementById('location-modal');
    if (modal) modal.style.display = 'flex';
    // 每次打开都重新加载国家列表，或者可以加入缓存逻辑
    populateCountries();
}
        async function fetchCityName(lat, lon) { try { const response = await fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${OWM_API_KEY}`); if (!response.ok) throw new Error('City name fetch failed'); const data = await response.json(); if (data.length > 0) { return data[0].name; } return DEFAULT_CITY; } catch (error) { console.error(error); return DEFAULT_CITY; } }
        async function fetchWeatherData(lat, lon) { try { const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}&units=metric&lang=zh_cn`); if (!response.ok) throw new Error('Weather data fetch failed'); globalWeatherData = await response.json(); updateWeatherUI(globalWeatherData); updateDerivedHealthIndices(globalWeatherData); updateLifeAdvice(); } catch (error) { console.error(error); document.getElementById('details-desc').textContent = '天气加载失败。'; } }
        async function fetchAstronomyData(lat, lon) { try { const response = await fetch(`https://api.ipgeolocation.io/astronomy?apiKey=${IPGEO_API_KEY}&lat=${lat}&long=${lon}`); if (!response.ok) throw new Error('Astronomy data fetch failed'); globalAstronomyData = await response.json(); updateAstronomyUI(globalAstronomyData); updateMoonImpact(); updateLifeAdvice(); } catch (error) { console.error(error); document.getElementById('overview-moon-phase').textContent = '加载失败'; } }
        async function fetchAirPollutionData(lat, lon) { try { const response = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}`); if (!response.ok) throw new Error('Air pollution data fetch failed'); const data = await response.json(); updateAirPollutionUI(data); } catch (error) { console.error(error); const aqiItem = document.getElementById('health-item-aqi'); if (aqiItem) aqiItem.dataset.value = "0"; } }
        async function fetchEcologyData(placeId) { try { const response = await fetch(`https://api.inaturalist.org/v1/observations?place_id=${placeId}&photos=true&per_page=5&order=desc&order_by=observed_on`); if (!response.ok) throw new Error('iNaturalist API fetch failed'); const data = await response.json(); updateEcologyUI(data); } catch (error) { console.error('Ecology data fetch failed', error); displayEcologyFallback(); } }
        async function fetchStockData() { const symbols = [{ symbol: 'BLK', name: '贝莱德' }, { symbol: 'TSLA', name: '特斯拉 (马斯克)' }, { symbol: 'DJT', name: '特朗普媒体' }, { symbol: 'NVDA', name: '英伟达 (AI/芯片)' }]; const stockList = document.getElementById('finance-stock-list'); stockList.innerHTML = ''; for (const item of symbols) { const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${item.symbol}&apikey=${ALPHAVANTAGE_API_KEY}`; try { await new Promise(resolve => setTimeout(resolve, 15000)); const response = await fetch(url); if (!response.ok) throw new Error(`Fetch failed for ${item.symbol}`); const data = await response.json(); if (data["Note"] || data["Error Message"] || !data["Global Quote"] || Object.keys(data["Global Quote"]).length === 0) { throw new Error(`API limit or error for ${item.symbol}`); } updateStockUI(item, data["Global Quote"]); } catch (error) { console.error(error); displayFinanceError(item, 'finance-stock-list'); } } }
        async function fetchCryptoData() { const cryptos = [{ id: 'bitcoin', symbol: 'BTC', name: '比特币' }, { id: 'ethereum', symbol: 'ETH', name: '以太坊' }, { id: 'solana', symbol: 'SOL', name: 'Solana' }, { id: 'binancecoin', symbol: 'BNB', name: '币安币' }]; const ids = cryptos.map(c => c.id).join(','); const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd&include_24hr_change=true`; const cryptoList = document.getElementById('crypto-list'); cryptoList.innerHTML = ''; try { const response = await fetch(url); if (!response.ok) throw new Error('CoinGecko API fetch failed'); const data = await response.json(); cryptos.forEach(crypto => { if (data[crypto.id]) { updateCryptoUI(crypto, data[crypto.id]); } }); } catch (error) { console.error("Crypto fetch error:", error); displayFinanceError({name: '加密货币数据', symbol: ''}, 'crypto-list', '数据加载失败，请稍后重试。'); } }

        // --- 3. UI Update Functions ---
        function updateWeatherUI(data) { if (!data || !data.list || !data.list.length === 0) return; const currentWeather = data.list[0]; const weatherIcon = getWeatherIcon(currentWeather.weather[0].id); document.getElementById('overview-weather-icon').textContent = weatherIcon; document.getElementById('details-weather-icon').textContent = weatherIcon; document.getElementById('overview-temp').textContent = `${Math.round(currentWeather.main.temp)}°C`; document.getElementById('overview-advice').textContent = currentWeather.weather[0].description; document.getElementById('details-temp').textContent = `${Math.round(currentWeather.main.temp)}°C`; document.getElementById('details-feels-like').textContent = `体感 ${Math.round(currentWeather.main.feels_like)}°C`; document.getElementById('details-desc').textContent = currentWeather.weather[0].description; document.getElementById('details-humidity').textContent = `${currentWeather.main.humidity} %`; document.getElementById('details-wind').textContent = `${currentWeather.wind.speed} m/s`; document.getElementById('details-pressure').textContent = `${currentWeather.main.pressure} hPa`; const forecastList = data.list.slice(0, 8); const chartContainer = document.getElementById('weather-chart-container'); chartContainer.innerHTML = `<div class="flex items-end justify-between h-32">${forecastList.map((item, index) => `<div class="text-center flex flex-col items-center"><div class="text-sm font-bold">${Math.round(item.main.temp)}°</div><div class="w-6 mx-auto bg-orange-300 rounded-t" style="height: ${Math.max(0, item.main.temp * 2.5)}px; min-height: 4px;"></div><span class="text-xs">${index === 0 ? '现在' : new Date(item.dt * 1000).getHours() + ':00'}</span></div>`).join('')}</div>`; }
        function updateAstronomyUI(data) { if (!data || !data.moon_phase || !data.sunrise) { console.error("Incomplete astronomy data received.", data); ['overview-moon-phase', 'moon-phase-name', 'moon-illumination', 'sunrise-time', 'sunset-time', 'moonrise-time', 'moonset-time'].forEach(id => { const el = document.getElementById(id); if(el) el.textContent = '加载失败'; }); return; } const formattedPhaseName = data.moon_phase.split('(')[0].trim().replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, char => char.toUpperCase()); const moonPhaseName = moonPhaseTranslations[formattedPhaseName] || formattedPhaseName; const moonEmoji = getMoonEmoji(formattedPhaseName); let illuminationText = '--'; const illuminationValue = parseFloat(data.moon_illumination); if (!isNaN(illuminationValue)) { illuminationText = (illuminationValue * 100).toFixed(1); } document.getElementById('overview-moon-icon').textContent = moonEmoji; document.getElementById('overview-moon-phase').textContent = moonPhaseName; document.getElementById('details-moon-icon').textContent = moonEmoji; document.getElementById('moon-visual').textContent = moonEmoji; document.getElementById('moon-phase-name').textContent = moonPhaseName; document.getElementById('moon-illumination').textContent = `${illuminationText} % 被照亮`; document.getElementById('sunrise-time').textContent = data.sunrise; document.getElementById('sunset-time').textContent = data.sunset; document.getElementById('moonrise-time').textContent = data.moonrise; document.getElementById('moonset-time').textContent = data.moonset; }
        function updateAirPollutionUI(data) { if (!data || !data.list || !data.list.length === 0) return; const aqi = data.list[0].main.aqi; let aqiValue, aqiText, aqiColor; switch (aqi) { case 1: aqiValue = 95; aqiText = "优"; aqiColor = '#10b981'; break; case 2: aqiValue = 80; aqiText = "良"; aqiColor = '#10b981'; break; case 3: aqiValue = 60; aqiText = "轻度"; aqiColor = '#f59e0b'; break; case 4: aqiValue = 40; aqiText = "中度"; aqiColor = '#ef4444'; break; case 5: aqiValue = 20; aqiText = "重度"; aqiColor = '#ef4444'; break; default: aqiValue = 50; aqiText = "未知"; aqiColor = '#6b7280'; } const aqiItem = document.getElementById('health-item-aqi'); if (aqiItem) { aqiItem.dataset.value = aqiValue; aqiItem.dataset.color = aqiColor; } document.getElementById('overview-health-status').textContent = aqiText; }
        function updateDerivedHealthIndices(data) { if (!data || !data.list || !data.list.length === 0) return; const weather = data.list[0]; const temp = weather.main.temp; const humidity = weather.main.humidity; const weatherId = weather.weather[0].id; let uvSafetyScore = 70; if (weatherId >= 801 && weatherId <= 804) uvSafetyScore = 50; if (weatherId === 800) uvSafetyScore = 30; let exerciseScore = 85; if (temp > 32) exerciseScore -= 40; if (temp < 20) exerciseScore -= 15; if (weatherId < 700) exerciseScore -= 50; let heatSafetyScore = 90; if (temp > 30 && humidity > 75) heatSafetyScore = 20; else if (temp > 28) heatSafetyScore = 50; const uvItem = document.getElementById('health-item-uv'); if (uvItem) uvItem.dataset.value = uvSafetyScore; const exerciseItem = document.getElementById('health-item-exercise'); if (exerciseItem) exerciseItem.dataset.value = Math.max(0, exerciseScore); const heatItem = document.getElementById('health-item-heat'); if (heatItem) heatItem.dataset.value = heatSafetyScore; const healthAdviceList = document.getElementById('health-advice-list'); if (healthAdviceList) { healthAdviceList.innerHTML = `<ul class="space-y-1 list-disc list-inside"><li>运动建议: ${exerciseScore > 60 ? '今日适合户外运动。' : '避免剧烈运动，注意休息。'}</li><li>紫外线提醒: ${uvSafetyScore < 60 ? '紫外线强，请做好防晒。' : '紫外线较弱，适宜活动。'}</li><li>防暑提醒: ${heatSafetyScore < 60 ? '天气炎热，谨防中暑。' : '天气舒适，注意补水。'}</li></ul>`; } const weatherAdviceList = document.getElementById('weather-advice-list'); if (weatherAdviceList) { weatherAdviceList.innerHTML = `<ul class="space-y-1 list-disc list-inside"><li>${weather.weather[0].description}，建议注意防晒并适时补充水分。</li></ul>`; } }
        function updateEcologyUI(data) { const ecologyList = document.getElementById('ecology-list'); if (!ecologyList) return; ecologyList.innerHTML = ''; if (data.results && data.results.length > 0) { data.results.forEach(obs => { const item = document.createElement('div'); item.className = 'bg-green-50 p-4 rounded-xl flex items-center gap-4'; const photo = obs.photos.length > 0 ? obs.photos[0] : { url: 'https://static.inaturalist.org/sites/1-logo-2017.svg' }; const smallUrl = photo.url.replace('square', 'medium'); const largeUrl = photo.url.replace('square', 'large'); const commonName = obs.taxon.preferred_common_name || obs.taxon.name; item.innerHTML = `<div class="flex-shrink-0 w-16 h-16 bg-cover bg-center rounded-lg shadow-sm cursor-pointer" style="background-image: url('${smallUrl}')" onclick="showImageModal('${largeUrl}')"></div><div><h3 class="font-bold text-green-800">${commonName}</h3><p class="text-sm text-gray-600">近期在本地被观察到。</p></div>`; ecologyList.appendChild(item); }); document.getElementById('overview-ecology-status').textContent = '物种活跃'; } else { displayEcologyFallback(); } }
        function displayEcologyFallback() { const ecologyList = document.getElementById('ecology-list'); ecologyList.innerHTML = `<div class="bg-gray-100 p-4 rounded-xl text-center text-gray-600"><p>本地生态信息加载失败或暂无数据，显示预设内容。</p></div><div class="bg-green-50 p-4 rounded-xl flex items-start gap-4"><span class="text-3xl mt-1">🥭</span><div><h3 class="font-bold text-green-800">榴莲果熟期</h3><p class="text-sm text-gray-600">正值本地多种水果成熟的季节。</p></div></div><div class="bg-blue-50 p-4 rounded-xl flex items-start gap-4"><span class="text-3xl mt-1">🦅</span><div><h3 class="font-bold text-blue-800">季风鸟类</h3><p class="text-sm text-gray-600">部分季风鸟类在此期间活动频繁。</p></div></div>`; document.getElementById('overview-ecology-status').textContent = '活跃期'; }
        function updateStockUI(item, quote) { const stockList = document.getElementById('finance-stock-list'); const price = parseFloat(quote["05. price"]); const change = parseFloat(quote["09. change"]); const changePercent = parseFloat(quote["10. change percent"].replace('%', '')); const isPositive = change >= 0; const colorClass = isPositive ? 'text-green-600' : 'text-red-600'; const sign = isPositive ? '+' : ''; const card = document.createElement('div'); card.className = 'p-4 bg-gray-50 rounded-xl border border-gray-200 flex items-center justify-between'; card.innerHTML = `<div><p class="font-bold text-lg text-gray-800">${item.name} <span class="text-sm font-mono text-gray-500">${item.symbol}</span></p><p class="text-2xl font-bold text-gray-900">$${price.toFixed(2)}</p></div><div class="text-right"><p class="text-lg font-semibold ${colorClass}">${sign}${change.toFixed(2)}</p><p class="text-sm ${colorClass}">(${sign}${changePercent.toFixed(2)}%)</p></div>`; stockList.appendChild(card); }
        function updateCryptoUI(cryptoInfo, quote) { const cryptoList = document.getElementById('crypto-list'); const price = parseFloat(quote.usd); const changePercent = parseFloat(quote.usd_24h_change); const change = (price * changePercent) / (100 + changePercent); const isPositive = changePercent >= 0; const colorClass = isPositive ? 'text-green-600' : 'text-red-600'; const sign = isPositive ? '+' : ''; const card = document.createElement('div'); card.className = 'p-4 bg-gray-50 rounded-xl border border-gray-200 flex items-center justify-between'; card.innerHTML = `<div><p class="font-bold text-lg text-gray-800">${cryptoInfo.name} <span class="text-sm font-mono text-gray-500">${cryptoInfo.symbol}</span></p><p class="text-2xl font-bold text-gray-900">$${price < 10 ? price.toFixed(4) : price.toFixed(2)}</p></div><div class="text-right"><p class="text-lg font-semibold ${colorClass}">${sign}${change.toFixed(2)}</p><p class="text-sm ${colorClass}">(${sign}${changePercent.toFixed(2)}%)</p></div>`; cryptoList.appendChild(card); }
        function displayFinanceError(item, listId, message = '数据加载失败。可能是API请求频率过高。') { const list = document.getElementById(listId); const card = document.createElement('div'); card.className = 'p-4 bg-red-50 rounded-xl border border-red-200'; card.innerHTML = `<p class="font-bold text-red-700">${item.name} (${item.symbol})</p><p class="text-sm text-red-600">${message}</p>`; list.appendChild(card); }
        function updateMoonImpact() { if (!globalAstronomyData) return; const now = new Date(); const hour = now.getHours(); const moonImpactList = document.getElementById('moon-ecology-impact'); if (moonImpactList) { const phaseName = (document.getElementById('moon-phase-name').textContent || "").trim(); let tips = []; if (phaseName === "满月" || phaseName === "盈凸月") { tips.push(`<li>${hour >= 18 ? '夜行生物活跃，适合生态观察。' : '傍晚后夜行生物将更活跃。'}</li>`, `<li>潮汐力强，${hour >= 14 ? '下午适合海钓。' : '下午是海钓的好时机。'}</li>`); } else { tips.push("<li>生物节律平稳，适合常规活动。</li>", "<li>潮汐平缓，近海活动相对安全。</li>"); } moonImpactList.innerHTML = tips.join(''); } }
        function updateLifeAdvice() { if (!globalWeatherData || !globalAstronomyData) return; const now = new Date(); const hour = now.getHours(); const weather = globalWeatherData.list[0]; const temp = weather.main.temp; const humidity = weather.main.humidity; const phaseName = (document.getElementById('moon-phase-name').textContent || "").trim(); const dietAdvice = document.getElementById('diet-advice'); const outdoorAdvice = document.getElementById('outdoor-advice'); const healthAdvice = document.getElementById('health-advice'); if(dietAdvice) dietAdvice.innerHTML = `<li>**清凉饮食**: 多喝${humidity > 75 ? '冬瓜汤' : '椰子水'}，解暑防湿。</li><li>**食物保鲜**: 高温${temp > 30 ? '易变质' : '正常'}，注意冷藏。</li>`; if(outdoorAdvice) outdoorAdvice.innerHTML = `<li>**最佳时间**: ${hour >= 14 && hour < 17 ? '当前时段炎热，建议傍晚' : '适合'}散步。</li><li>**必备物品**: ${temp > 30 ? '太阳帽、防晒霜' : '轻便衣物'}、饮用水。</li>`; if(healthAdvice) healthAdvice.innerHTML = `<li>晚夏湿热，${phaseName === '盈凸月' ? '盈凸月养阴' : '月相平稳'}。饮食清淡。</li><li>下午2点后${hour >= 14 ? '避免' : '适度'}活动，午休养心。</li><li>穴位按摩：合谷穴清热，太冲穴疏肝。</li>`; }

        // --- 4. Helper & Modal Functions ---
        function showImageModal(imageUrl) { const modal = document.getElementById('image-modal'); const modalImage = document.getElementById('modal-image'); if (modal && modalImage) { modalImage.src = imageUrl; modal.style.display = 'flex'; } }
        function hideImageModal() { const modal = document.getElementById('image-modal'); if (modal) { modal.style.display = 'none'; } }
        function getMoonEmoji(phase) { if (phase.includes("New Moon")) return "🌑"; if (phase.includes("Waxing Crescent")) return "🌒"; if (phase.includes("First Quarter")) return "🌓"; if (phase.includes("Waxing Gibbous")) return "🌔"; if (phase.includes("Full Moon")) return "🌕"; if (phase.includes("Waning Gibbous")) return "🌖"; if (phase.includes("Last Quarter")) return "🌗"; if (phase.includes("Waning Crescent")) return "🌘"; return "🌙"; }
        function getWeatherIcon(id) { if (id >= 200 && id < 300) return '⛈️'; if (id >= 300 && id < 400) return '🌦️'; if (id >= 500 && id < 600) return '🌧️'; if (id >= 600 && id < 700) return '❄️'; if (id >= 700 && id < 800) return '🌫️'; if (id === 800) return '☀️'; if (id === 801) return '🌤️'; if (id === 802) return '🌥️'; if (id > 802) return '☁️'; return '🌡️'; }
        function updateHealthItem(elementId, value, color) { const item = document.getElementById(elementId); if (!item) return; const circle = item.querySelector('.progress-circle'); const textSpan = item.querySelector('.absolute span'); if (!circle || !textSpan) return; const circumference = 2 * Math.PI * 40; const offset = circumference - (value / 100) * circumference; circle.style.strokeDashoffset = offset; circle.style.stroke = color; textSpan.textContent = `${value}%`; textSpan.style.color = color; }
        async function showLocationModal() { const modal = document.getElementById('location-modal'); if (modal) modal.style.display = 'flex'; if (countries.length === 0) { try { const response = await fetch('https://raw.githubusercontent.com/dr5hn/countries-states-cities-database/master/countries.json'); countries = await response.json(); populateCountries(); } catch (error) { console.error("Failed to load country data", error); } } }
        function hideLocationModal() { const modal = document.getElementById('location-modal'); if (modal) modal.style.display = 'none'; }
        function populateCountries() { const countrySelect = document.getElementById('country-select'); countrySelect.innerHTML = '<option value="">-- 选择国家 --</option>'; countries.sort((a, b) => a.name.localeCompare(b.name)).forEach(country => { const option = document.createElement('option'); option.value = country.iso2; option.textContent = country.name; countrySelect.appendChild(option); }); }
        async function populateStates(countryCode) { const stateSelect = document.getElementById('state-select'); stateSelect.innerHTML = '<option>正在加载州/省...</option>'; stateSelect.disabled = true; if (states.length === 0) { const response = await fetch('https://raw.githubusercontent.com/dr5hn/countries-states-cities-database/master/states.json'); states = await response.json(); } const countryStates = states.filter(s => s.country_code === countryCode); stateSelect.innerHTML = '<option value="">-- 选择州/省 --</option>'; countryStates.sort((a, b) => a.name.localeCompare(b.name)).forEach(state => { const option = document.createElement('option'); option.value = state.iso2; option.dataset.stateId = state.id; option.textContent = state.name; stateSelect.appendChild(option); }); stateSelect.disabled = false; }
        async function populateCities(stateId) { const citySelect = document.getElementById('city-select'); citySelect.innerHTML = '<option>正在加载城市...</option>'; citySelect.disabled = true; if (cities.length === 0) { const response = await fetch('https://raw.githubusercontent.com/dr5hn/countries-states-cities-database/master/cities.json'); cities = await response.json(); } const stateCities = cities.filter(c => c.state_id === stateId); citySelect.innerHTML = '<option value="">-- 选择城市 --</option>'; stateCities.sort((a, b) => a.name.localeCompare(b.name)).forEach(city => { const option = document.createElement('option'); option.value = city.name; option.dataset.lat = city.latitude; option.dataset.lon = city.longitude; option.textContent = city.name; citySelect.appendChild(option); }); citySelect.disabled = false; }

        // --- 5. Core UI Interaction ---
        function updateTime() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' }); document.getElementById('current-time').textContent = timeString; const dateString = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }); document.getElementById('overview-date').textContent = dateString; }
        function nextLayer() { goToLayer((currentLayer % totalLayers) + 1); }
        function prevLayer() { goToLayer(currentLayer === 1 ? totalLayers : currentLayer - 1); }
        function goToLayer(layerNum) { if (layerNum === currentLayer) return; const direction = determineDirection(layerNum); const oldLayer = document.getElementById(`layer-${currentLayer}`); const newLayer = document.getElementById(`layer-${layerNum}`); newLayer.classList.add(`${direction}-in`); requestAnimationFrame(() => { oldLayer.classList.add(`${direction}-out`); oldLayer.classList.remove('active'); newLayer.classList.add('active'); newLayer.classList.remove(`${direction}-in`); }); setTimeout(() => { document.querySelectorAll('.card-layer').forEach(layer => { if (layer.id !== newLayer.id) { layer.className = 'card-layer'; } }); }, 600); updateNav(layerNum); currentLayer = layerNum; triggerEntryAnimations(newLayer); }
        function determineDirection(targetLayer) { if (currentLayer === totalLayers && targetLayer === 1) return 'next'; if (currentLayer === 1 && targetLayer === totalLayers) return 'prev'; return targetLayer > currentLayer ? 'next' : 'prev'; }
        function updateNav(layerNum) { document.querySelectorAll('.nav-dot').forEach(dot => dot.classList.remove('active')); document.querySelector(`.nav-dot[data-layer="${layerNum}"]`).classList.add('active'); document.getElementById('current-layer').textContent = `第${layerNum}层`; document.getElementById('layer-title').textContent = layerTitles[layerNum]; }
        function triggerEntryAnimations(container) {
            container.querySelectorAll('[data-anim]').forEach(el => { el.classList.remove('fade-in-up'); void el.offsetWidth; el.classList.add('fade-in-up'); });
            if (container.id === 'layer-4') {
                container.querySelectorAll('.health-item').forEach(item => {
                    const value = parseInt(item.dataset.value, 10) || 0;
                    const color = item.dataset.color || '#6b7280';
                    updateHealthItem(item.id, value, color);
                });
            }
        }

        // --- 6. Page Load & Geolocation ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeWithLocation();
            setInterval(updateTime, 1000);
            updateTime();
            triggerEntryAnimations(document.getElementById('layer-1'));
            document.addEventListener('keydown', e => { if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextLayer(); } else if (e.key === 'ArrowLeft') { e.preventDefault(); prevLayer(); } else if (e.key === 'Home') { e.preventDefault(); goToLayer(1); } else if (e.key === 'End') { e.preventDefault(); goToLayer(totalLayers); } });
            document.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
            document.addEventListener('touchend', e => { const diffX = startX - e.changedTouches[0].clientX; if (Math.abs(diffX) > 50) { diffX > 0 ? nextLayer() : prevLayer(); } });
            document.getElementById('country-select').addEventListener('change', (e) => { document.getElementById('state-select').innerHTML = '<option>请先选择国家</option>'; document.getElementById('state-select').disabled = true; document.getElementById('city-select').innerHTML = '<option>请先选择州/省</option>'; document.getElementById('city-select').disabled = true; document.getElementById('confirm-location-btn').disabled = true; populateStates(e.target.value); });
            document.getElementById('state-select').addEventListener('change', (e) => { const selectedOption = e.target.options[e.target.selectedIndex]; const stateId = parseInt(selectedOption.dataset.stateId); document.getElementById('city-select').innerHTML = '<option>请先选择州/省</option>'; document.getElementById('city-select').disabled = true; document.getElementById('confirm-location-btn').disabled = true; populateCities(stateId); });
            document.getElementById('city-select').addEventListener('change', (e) => { document.getElementById('confirm-location-btn').disabled = e.target.value === ""; });
            document.getElementById('confirm-location-btn').addEventListener('click', () => { const citySelect = document.getElementById('city-select'); const selectedOption = citySelect.options[citySelect.selectedIndex]; const lat = parseFloat(selectedOption.dataset.lat); const lon = parseFloat(selectedOption.dataset.lon); const cityName = selectedOption.value; document.getElementById('location-display').querySelector('span').textContent = cityName; fetchAllData(lat, lon, DEFAULT_INAT_PLACE_ID); hideLocationModal(); });
        });

        function initializeWithLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const cityName = await fetchCityName(lat, lon);
                        document.getElementById('location-display').querySelector('span').textContent = cityName;
                        fetchAllData(lat, lon, DEFAULT_INAT_PLACE_ID);
                    },
                    () => {
                        console.log("Geolocation permission denied. Using default location.");
                        document.getElementById('location-display').querySelector('span').textContent = `马来西亚 · ${DEFAULT_CITY}`;
                        fetchAllData(DEFAULT_LAT, DEFAULT_LNG, DEFAULT_INAT_PLACE_ID);
                    }
                );
            } else {
                console.log("Geolocation is not supported. Using default location.");
                document.getElementById('location-display').querySelector('span').textContent = `马来西亚 · ${DEFAULT_CITY}`;
                fetchAllData(DEFAULT_LAT, DEFAULT_LNG, DEFAULT_INAT_PLACE_ID);
            }
        }

        function fetchAllData(lat, lon, placeId) {
            fetchWeatherData(lat, lon);
            fetchAstronomyData(lat, lon);
            fetchAirPollutionData(lat, lon);
            fetchEcologyData(placeId);
            fetchStockData();
            fetchCryptoData();
        }
    </script>
</body>
</html>
