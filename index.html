<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç”Ÿæ´»æ™ºæ…§æ—¥å†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
        
        body { background: linear-gradient(135deg, #1e3c72, #2a5298, #1e3c72); background-size: 200% 200%; animation: animated-gradient 15s ease infinite; min-height: 100vh; overflow-x: hidden; font-family: 'Noto Sans SC', sans-serif; }
        @keyframes animated-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .card-layer { position: absolute; width: 100%; height: 100%; transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; backface-visibility: hidden; opacity: 0; pointer-events: none; }
        .card-layer.active { transform: translateX(0) scale(1); opacity: 1; pointer-events: auto; }
        .card-layer.prev-out { transform: translateX(-50%) scale(0.9); opacity: 0; }
        .card-layer.next-out { transform: translateX(50%) scale(0.9); opacity: 0; }
        .card-layer.next-in { transform: translateX(50%) scale(0.9); }
        .card-layer.prev-in { transform: translateX(-50%) scale(0.9); }
        .main-card { backdrop-filter: blur(25px) saturate(180%); background: rgba(255, 255, 255, 0.9); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transition: all 0.3s ease; }
        .main-card:hover { transform: translateY(-8px); box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.3); }
        .nav-dot { width: 12px; height: 12px; border-radius: 50%; background: rgba(255, 255, 255, 0.4); cursor: pointer; transition: all 0.3s ease; }
        .nav-dot.active { background: #ffffff; transform: scale(1.3); box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s ease; color: white; }
        .btn-primary:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 10px 20px rgba(118, 75, 162, 0.4); }
        .btn-secondary { background: rgba(230, 232, 240, 0.8); border: 1px solid rgba(0, 0, 0, 0.05); color: #334155; transition: all 0.3s ease;}
        .btn-secondary:hover { background: rgba(214, 219, 231, 0.9); transform: scale(1.05) translateY(-2px); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; }
        .info-block { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .info-block:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .progress-circle { transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; cursor: pointer; }
        .modal-content { max-width: 90vw; max-height: 90vh; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border-radius: 1rem; }
        select:disabled { cursor: not-allowed; }
    </style>
</head>
<body class="flex flex-col items-center justify-center text-gray-800 p-4">
    <!-- Header -->
    <div class="text-center py-6">
        <h1 class="text-4xl md:text-5xl font-bold text-white mb-2 flex items-center justify-center gap-x-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-.464 5.535a1 1 0 10-1.415-1.414 3 3 0 01-4.242 0 1 1 0 00-1.415 1.414 5 5 0 007.072 0z" clip-rule="evenodd" /></svg>
            ç”Ÿæ´»æ™ºæ…§æ—¥å†
        </h1>
        <p id="location-display" class="text-white/80 text-lg cursor-pointer hover:opacity-80 transition-opacity flex items-center justify-center gap-x-2" onclick="showLocationModal()">
            <span>æ­£åœ¨è·å–ä½ç½®...</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
            </svg>
        </p>
        <div class="text-xl font-mono text-white/90 mt-2" id="current-time"></div>
    </div>

    <!-- Main Card Container -->
    <div class="max-w-4xl mx-auto px-4 w-full">
        <div class="relative h-[650px] mb-8">
            <!-- All 8 Layers HTML is here -->
        </div>
        
        <!-- Navigation Dots -->
        <div class="flex justify-center space-x-4 mb-8">
            <!-- 8 nav dots here -->
        </div>
        
        <!-- Layer Info -->
        <div class="text-center text-white/80">
            <p class="text-sm"><span id="current-layer">ç¬¬1å±‚</span> / å…±8å±‚ <span class="mx-2">â€¢</span> <span id="layer-title">ä»Šæ—¥æ¦‚è§ˆ</span></p>
        </div>
    </div>

    <!-- Modals -->
    <div id="image-modal" class="modal-overlay" onclick="hideImageModal()">
        <img id="modal-image" src="" alt="æ”¾å¤§çš„ç”Ÿæ€å›¾ç‰‡" class="modal-content" />
    </div>
    <div id="location-modal" class="modal-overlay" style="--tw-bg-opacity: 0.5;">
        <div class="main-card rounded-2xl p-6 md:p-8 w-full max-w-lg mx-4" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">é€‰æ‹©æ‚¨çš„ä½ç½®</h2>
            <div class="space-y-4">
                <div>
                    <label for="country-select" class="block text-sm font-medium text-gray-700">å›½å®¶</label>
                    <select id="country-select" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option>æ­£åœ¨åŠ è½½å›½å®¶...</option>
                    </select>
                </div>
                <div>
                    <label for="state-select" class="block text-sm font-medium text-gray-700">å· / çœ</label>
                    <select id="state-select" disabled class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm sm:text-sm">
                        <option>è¯·å…ˆé€‰æ‹©å›½å®¶</option>
                    </select>
                </div>
                <div>
                    <label for="city-select" class="block text-sm font-medium text-gray-700">åŸå¸‚</label>
                    <select id="city-select" disabled class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-gray-100 rounded-md shadow-sm sm:text-sm">
                        <option>è¯·å…ˆé€‰æ‹©å·/çœ</option>
                    </select>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-x-4">
                <button class="btn-secondary px-6 py-2 rounded-lg" onclick="hideLocationModal()">å–æ¶ˆ</button>
                <button id="confirm-location-btn" class="btn-primary px-6 py-2 rounded-lg shadow-lg" disabled>ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- 1. State and Constants ---
        let currentLayer = 1;
        const totalLayers = 8;
        const layerTitles = { 1: "ä»Šæ—¥æ¦‚è§ˆ", 2: "å¤©æ°”è¯¦æƒ…", 3: "æœˆç›¸è¯¦æƒ…", 4: "å¥åº·æŒ‡æ•°", 5: "ç”Ÿæ€è§‚å¯Ÿ", 6: "ç”Ÿæ´»å»ºè®®", 7: "é‡‘èåŠ¨æ€ (è‚¡ç¥¨)", 8: "åŠ å¯†è´§å¸" };
        let startX = 0;

        const OWM_API_KEY = 'f1f0de33939644fa3b20ea3e43ea4ac8';
        const IPGEO_API_KEY = 'ed130362fced4526a6f913e38886310c';
        const ALPHAVANTAGE_API_KEY = 'D6XEDCZR5KXTAYG6';
        
        const SUPABASE_URL = 'https://exmfareyaysyvicxyekc.supabase.co';      
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV4bWZhcmV5YXlzeXZpY3h5ZWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0NDQ4NDUsImV4cCI6MjA3MDAyMDg0NX0.9Pvq56Yee_6TbWjfqrtWb1crIupumw_F8Ts6gLSZMnM';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const DEFAULT_CITY = 'Tawau';
        const DEFAULT_LAT = 4.24;
        const DEFAULT_LNG = 117.88;
        const DEFAULT_INAT_PLACE_ID = 119846;
        
        const moonPhaseTranslations = { "New Moon": "æ–°æœˆ", "Waxing Crescent": "å¨¥çœ‰æœˆ", "First Quarter": "ä¸Šå¼¦æœˆ", "Waxing Gibbous": "ç›ˆå‡¸æœˆ", "Full Moon": "æ»¡æœˆ", "Waning Gibbous": "äºå‡¸æœˆ", "Last Quarter": "ä¸‹å¼¦æœˆ", "Waning Crescent": "æ®‹æœˆ" };

        let globalWeatherData = null;
        let globalAstronomyData = null;

        // --- 2. API Fetching & Data Handling ---
        
        async function fetchCityName(lat, lon) { try { const response = await fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${lat}&lon=${lon}&limit=1&appid=${OWM_API_KEY}`); if (!response.ok) throw new Error('City name fetch failed'); const data = await response.json(); if (data.length > 0) { return data[0].name; } return DEFAULT_CITY; } catch (error) { console.error(error); return DEFAULT_CITY; } }
        async function fetchWeatherData(lat, lon) { try { const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}&units=metric&lang=zh_cn`); if (!response.ok) throw new Error('Weather data fetch failed'); globalWeatherData = await response.json(); updateWeatherUI(globalWeatherData); updateDerivedHealthIndices(globalWeatherData); updateLifeAdvice(); } catch (error) { console.error(error); document.getElementById('details-desc').textContent = 'å¤©æ°”åŠ è½½å¤±è´¥ã€‚'; } }
        async function fetchAstronomyData(lat, lon) { try { const response = await fetch(`https://api.ipgeolocation.io/astronomy?apiKey=${IPGEO_API_KEY}&lat=${lat}&long=${lon}`); if (!response.ok) throw new Error('Astronomy data fetch failed'); globalAstronomyData = await response.json(); updateAstronomyUI(globalAstronomyData); updateMoonImpact(); updateLifeAdvice(); } catch (error) { console.error(error); document.getElementById('overview-moon-phase').textContent = 'åŠ è½½å¤±è´¥'; } }
        async function fetchAirPollutionData(lat, lon) { try { const response = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}`); if (!response.ok) throw new Error('Air pollution data fetch failed'); const data = await response.json(); updateAirPollutionUI(data); } catch (error) { console.error(error); const aqiItem = document.getElementById('health-item-aqi'); if (aqiItem) aqiItem.dataset.value = "0"; } }
        async function fetchEcologyData(placeId) { try { const response = await fetch(`https://api.inaturalist.org/v1/observations?place_id=${placeId}&photos=true&per_page=5&order=desc&order_by=observed_on`); if (!response.ok) throw new Error('iNaturalist API fetch failed'); const data = await response.json(); updateEcologyUI(data); } catch (error) { console.error('Ecology data fetch failed', error); displayEcologyFallback(); } }
        async function fetchStockData() { const symbols = [{ symbol: 'BLK', name: 'è´è±å¾·' }, { symbol: 'TSLA', name: 'ç‰¹æ–¯æ‹‰ (é©¬æ–¯å…‹)' }, { symbol: 'DJT', name: 'ç‰¹æœ—æ™®åª’ä½“' }, { symbol: 'NVDA', name: 'è‹±ä¼Ÿè¾¾ (AI/èŠ¯ç‰‡)' }]; const stockList = document.getElementById('finance-stock-list'); stockList.innerHTML = ''; for (const item of symbols) { const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${item.symbol}&apikey=${ALPHAVANTAGE_API_KEY}`; try { await new Promise(resolve => setTimeout(resolve, 15000)); const response = await fetch(url); if (!response.ok) throw new Error(`Fetch failed for ${item.symbol}`); const data = await response.json(); if (data["Note"] || data["Error Message"] || !data["Global Quote"] || Object.keys(data["Global Quote"]).length === 0) { throw new Error(`API limit or error for ${item.symbol}`); } updateStockUI(item, data["Global Quote"]); } catch (error) { console.error(error); displayFinanceError(item, 'finance-stock-list'); } } }
        async function fetchCryptoData() { const cryptos = [{ id: 'bitcoin', symbol: 'BTC', name: 'æ¯”ç‰¹å¸' }, { id: 'ethereum', symbol: 'ETH', name: 'ä»¥å¤ªåŠ' }, { id: 'solana', symbol: 'SOL', name: 'Solana' }, { id: 'binancecoin', symbol: 'BNB', name: 'å¸å®‰å¸' }]; const ids = cryptos.map(c => c.id).join(','); const url = `https://api.coingecko.com/api/v3/simple/price?ids=${ids}&vs_currencies=usd&include_24hr_change=true`; const cryptoList = document.getElementById('crypto-list'); cryptoList.innerHTML = ''; try { const response = await fetch(url); if (!response.ok) throw new Error('CoinGecko API fetch failed'); const data = await response.json(); cryptos.forEach(crypto => { if (data[crypto.id]) { updateCryptoUI(crypto, data[crypto.id]); } }); } catch (error) { console.error("Crypto fetch error:", error); displayFinanceError({name: 'åŠ å¯†è´§å¸æ•°æ®', symbol: ''}, 'crypto-list', 'æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚'); } }

        // --- 3. UI Update Functions ---
        function updateWeatherUI(data) { if (!data || !data.list || !data.list.length === 0) return; const currentWeather = data.list[0]; const weatherIcon = getWeatherIcon(currentWeather.weather[0].id); document.getElementById('overview-weather-icon').textContent = weatherIcon; document.getElementById('details-weather-icon').textContent = weatherIcon; document.getElementById('overview-temp').textContent = `${Math.round(currentWeather.main.temp)}Â°C`; document.getElementById('overview-advice').textContent = currentWeather.weather[0].description; document.getElementById('details-temp').textContent = `${Math.round(currentWeather.main.temp)}Â°C`; document.getElementById('details-feels-like').textContent = `ä½“æ„Ÿ ${Math.round(currentWeather.main.feels_like)}Â°C`; document.getElementById('details-desc').textContent = currentWeather.weather[0].description; document.getElementById('details-humidity').textContent = `${currentWeather.main.humidity} %`; document.getElementById('details-wind').textContent = `${currentWeather.wind.speed} m/s`; document.getElementById('details-pressure').textContent = `${currentWeather.main.pressure} hPa`; const forecastList = data.list.slice(0, 8); const chartContainer = document.getElementById('weather-chart-container'); chartContainer.innerHTML = `<div class="flex items-end justify-between h-32">${forecastList.map((item, index) => `<div class="text-center flex flex-col items-center"><div class="text-sm font-bold">${Math.round(item.main.temp)}Â°</div><div class="w-6 mx-auto bg-orange-300 rounded-t" style="height: ${Math.max(0, item.main.temp * 2.5)}px; min-height: 4px;"></div><span class="text-xs">${index === 0 ? 'ç°åœ¨' : new Date(item.dt * 1000).getHours() + ':00'}</span></div>`).join('')}</div>`; }
        function updateAstronomyUI(data) { if (!data || !data.moon_phase || !data.sunrise) { console.error("Incomplete astronomy data received.", data); ['overview-moon-phase', 'moon-phase-name', 'moon-illumination', 'sunrise-time', 'sunset-time', 'moonrise-time', 'moonset-time'].forEach(id => { const el = document.getElementById(id); if(el) el.textContent = 'åŠ è½½å¤±è´¥'; }); return; } const formattedPhaseName = data.moon_phase.split('(')[0].trim().replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, char => char.toUpperCase()); const moonPhaseName = moonPhaseTranslations[formattedPhaseName] || formattedPhaseName; const moonEmoji = getMoonEmoji(formattedPhaseName); let illuminationText = '--'; const illuminationValue = parseFloat(data.moon_illumination); if (!isNaN(illuminationValue)) { illuminationText = (illuminationValue * 100).toFixed(1); } document.getElementById('overview-moon-icon').textContent = moonEmoji; document.getElementById('overview-moon-phase').textContent = moonPhaseName; document.getElementById('details-moon-icon').textContent = moonEmoji; document.getElementById('moon-visual').textContent = moonEmoji; document.getElementById('moon-phase-name').textContent = moonPhaseName; document.getElementById('moon-illumination').textContent = `${illuminationText} % è¢«ç…§äº®`; document.getElementById('sunrise-time').textContent = data.sunrise; document.getElementById('sunset-time').textContent = data.sunset; document.getElementById('moonrise-time').textContent = data.moonrise; document.getElementById('moonset-time').textContent = data.moonset; }
        function updateAirPollutionUI(data) { if (!data || !data.list || !data.list.length === 0) return; const aqi = data.list[0].main.aqi; let aqiValue, aqiText, aqiColor; switch (aqi) { case 1: aqiValue = 95; aqiText = "ä¼˜"; aqiColor = '#10b981'; break; case 2: aqiValue = 80; aqiText = "è‰¯"; aqiColor = '#10b981'; break; case 3: aqiValue = 60; aqiText = "è½»åº¦"; aqiColor = '#f59e0b'; break; case 4: aqiValue = 40; aqiText = "ä¸­åº¦"; aqiColor = '#ef4444'; break; case 5: aqiValue = 20; aqiText = "é‡åº¦"; aqiColor = '#ef4444'; break; default: aqiValue = 50; aqiText = "æœªçŸ¥"; aqiColor = '#6b7280'; } const aqiItem = document.getElementById('health-item-aqi'); if (aqiItem) { aqiItem.dataset.value = aqiValue; aqiItem.dataset.color = aqiColor; } document.getElementById('overview-health-status').textContent = aqiText; }
        function updateDerivedHealthIndices(data) { if (!data || !data.list || !data.list.length === 0) return; const weather = data.list[0]; const temp = weather.main.temp; const humidity = weather.main.humidity; const weatherId = weather.weather[0].id; let uvSafetyScore = 70; if (weatherId >= 801 && weatherId <= 804) uvSafetyScore = 50; if (weatherId === 800) uvSafetyScore = 30; let exerciseScore = 85; if (temp > 32) exerciseScore -= 40; if (temp < 20) exerciseScore -= 15; if (weatherId < 700) exerciseScore -= 50; let heatSafetyScore = 90; if (temp > 30 && humidity > 75) heatSafetyScore = 20; else if (temp > 28) heatSafetyScore = 50; const uvItem = document.getElementById('health-item-uv'); if (uvItem) uvItem.dataset.value = uvSafetyScore; const exerciseItem = document.getElementById('health-item-exercise'); if (exerciseItem) exerciseItem.dataset.value = Math.max(0, exerciseScore); const heatItem = document.getElementById('health-item-heat'); if (heatItem) heatItem.dataset.value = heatSafetyScore; const healthAdviceList = document.getElementById('health-advice-list'); if (healthAdviceList) { healthAdviceList.innerHTML = `<ul class="space-y-1 list-disc list-inside"><li>è¿åŠ¨å»ºè®®: ${exerciseScore > 60 ? 'ä»Šæ—¥é€‚åˆæˆ·å¤–è¿åŠ¨ã€‚' : 'é¿å…å‰§çƒˆè¿åŠ¨ï¼Œæ³¨æ„ä¼‘æ¯ã€‚'}</li><li>ç´«å¤–çº¿æé†’: ${uvSafetyScore < 60 ? 'ç´«å¤–çº¿å¼ºï¼Œè¯·åšå¥½é˜²æ™’ã€‚' : 'ç´«å¤–çº¿è¾ƒå¼±ï¼Œé€‚å®œæ´»åŠ¨ã€‚'}</li><li>é˜²æš‘æé†’: ${heatSafetyScore < 60 ? 'å¤©æ°”ç‚çƒ­ï¼Œè°¨é˜²ä¸­æš‘ã€‚' : 'å¤©æ°”èˆ’é€‚ï¼Œæ³¨æ„è¡¥æ°´ã€‚'}</li></ul>`; } const weatherAdviceList = document.getElementById('weather-advice-list'); if (weatherAdviceList) { weatherAdviceList.innerHTML = `<ul class="space-y-1 list-disc list-inside"><li>${weather.weather[0].description}ï¼Œå»ºè®®æ³¨æ„é˜²æ™’å¹¶é€‚æ—¶è¡¥å……æ°´åˆ†ã€‚</li></ul>`; } }
        function updateEcologyUI(data) { const ecologyList = document.getElementById('ecology-list'); if (!ecologyList) return; ecologyList.innerHTML = ''; if (data.results && data.results.length > 0) { data.results.forEach(obs => { const item = document.createElement('div'); item.className = 'bg-green-50 p-4 rounded-xl flex items-center gap-4'; const photo = obs.photos.length > 0 ? obs.photos[0] : { url: 'https://static.inaturalist.org/sites/1-logo-2017.svg' }; const smallUrl = photo.url.replace('square', 'medium'); const largeUrl = photo.url.replace('square', 'large'); const commonName = obs.taxon.preferred_common_name || obs.taxon.name; item.innerHTML = `<div class="flex-shrink-0 w-16 h-16 bg-cover bg-center rounded-lg shadow-sm cursor-pointer" style="background-image: url('${smallUrl}')" onclick="showImageModal('${largeUrl}')"></div><div><h3 class="font-bold text-green-800">${commonName}</h3><p class="text-sm text-gray-600">è¿‘æœŸåœ¨æœ¬åœ°è¢«è§‚å¯Ÿåˆ°ã€‚</p></div>`; ecologyList.appendChild(item); }); document.getElementById('overview-ecology-status').textContent = 'ç‰©ç§æ´»è·ƒ'; } else { displayEcologyFallback(); } }
        function displayEcologyFallback() { const ecologyList = document.getElementById('ecology-list'); ecologyList.innerHTML = `<div class="bg-gray-100 p-4 rounded-xl text-center text-gray-600"><p>æœ¬åœ°ç”Ÿæ€ä¿¡æ¯åŠ è½½å¤±è´¥æˆ–æš‚æ— æ•°æ®ï¼Œæ˜¾ç¤ºé¢„è®¾å†…å®¹ã€‚</p></div><div class="bg-green-50 p-4 rounded-xl flex items-start gap-4"><span class="text-3xl mt-1">ğŸ¥­</span><div><h3 class="font-bold text-green-800">æ¦´è²æœç†ŸæœŸ</h3><p class="text-sm text-gray-600">æ­£å€¼æœ¬åœ°å¤šç§æ°´æœæˆç†Ÿçš„å­£èŠ‚ã€‚</p></div></div><div class="bg-blue-50 p-4 rounded-xl flex items-start gap-4"><span class="text-3xl mt-1">ğŸ¦…</span><div><h3 class="font-bold text-blue-800">å­£é£é¸Ÿç±»</h3><p class="text-sm text-gray-600">éƒ¨åˆ†å­£é£é¸Ÿç±»åœ¨æ­¤æœŸé—´æ´»åŠ¨é¢‘ç¹ã€‚</p></div></div>`; document.getElementById('overview-ecology-status').textContent = 'æ´»è·ƒæœŸ'; }
        function updateStockUI(item, quote) { const stockList = document.getElementById('finance-stock-list'); const price = parseFloat(quote["05. price"]); const change = parseFloat(quote["09. change"]); const changePercent = parseFloat(quote["10. change percent"].replace('%', '')); const isPositive = change >= 0; const colorClass = isPositive ? 'text-green-600' : 'text-red-600'; const sign = isPositive ? '+' : ''; const card = document.createElement('div'); card.className = 'p-4 bg-gray-50 rounded-xl border border-gray-200 flex items-center justify-between'; card.innerHTML = `<div><p class="font-bold text-lg text-gray-800">${item.name} <span class="text-sm font-mono text-gray-500">${item.symbol}</span></p><p class="text-2xl font-bold text-gray-900">$${price.toFixed(2)}</p></div><div class="text-right"><p class="text-lg font-semibold ${colorClass}">${sign}${change.toFixed(2)}</p><p class="text-sm ${colorClass}">(${sign}${changePercent.toFixed(2)}%)</p></div>`; stockList.appendChild(card); }
        function updateCryptoUI(cryptoInfo, quote) { const cryptoList = document.getElementById('crypto-list'); const price = parseFloat(quote.usd); const changePercent = parseFloat(quote.usd_24h_change); const change = (price * changePercent) / (100 + changePercent); const isPositive = changePercent >= 0; const colorClass = isPositive ? 'text-green-600' : 'text-red-600'; const sign = isPositive ? '+' : ''; const card = document.createElement('div'); card.className = 'p-4 bg-gray-50 rounded-xl border border-gray-200 flex items-center justify-between'; card.innerHTML = `<div><p class="font-bold text-lg text-gray-800">${cryptoInfo.name} <span class="text-sm font-mono text-gray-500">${cryptoInfo.symbol}</span></p><p class="text-2xl font-bold text-gray-900">$${price < 10 ? price.toFixed(4) : price.toFixed(2)}</p></div><div class="text-right"><p class="text-lg font-semibold ${colorClass}">${sign}${change.toFixed(2)}</p><p class="text-sm ${colorClass}">(${sign}${changePercent.toFixed(2)}%)</p></div>`; cryptoList.appendChild(card); }
        function displayFinanceError(item, listId, message = 'æ•°æ®åŠ è½½å¤±è´¥ã€‚å¯èƒ½æ˜¯APIè¯·æ±‚é¢‘ç‡è¿‡é«˜ã€‚') { const list = document.getElementById(listId); const card = document.createElement('div'); card.className = 'p-4 bg-red-50 rounded-xl border border-red-200'; card.innerHTML = `<p class="font-bold text-red-700">${item.name} (${item.symbol})</p><p class="text-sm text-red-600">${message}</p>`; list.appendChild(card); }
        function updateMoonImpact() { if (!globalAstronomyData) return; const now = new Date(); const hour = now.getHours(); const moonImpactList = document.getElementById('moon-ecology-impact'); if (moonImpactList) { const phaseName = (document.getElementById('moon-phase-name').textContent || "").trim(); let tips = []; if (phaseName === "æ»¡æœˆ" || phaseName === "ç›ˆå‡¸æœˆ") { tips.push(`<li>${hour >= 18 ? 'å¤œè¡Œç”Ÿç‰©æ´»è·ƒï¼Œé€‚åˆç”Ÿæ€è§‚å¯Ÿã€‚' : 'å‚æ™šåå¤œè¡Œç”Ÿç‰©å°†æ›´æ´»è·ƒã€‚'}</li>`, `<li>æ½®æ±åŠ›å¼ºï¼Œ${hour >= 14 ? 'ä¸‹åˆé€‚åˆæµ·é’“ã€‚' : 'ä¸‹åˆæ˜¯æµ·é’“çš„å¥½æ—¶æœºã€‚'}</li>`); } else { tips.push("<li>ç”Ÿç‰©èŠ‚å¾‹å¹³ç¨³ï¼Œé€‚åˆå¸¸è§„æ´»åŠ¨ã€‚</li>", "<li>æ½®æ±å¹³ç¼“ï¼Œè¿‘æµ·æ´»åŠ¨ç›¸å¯¹å®‰å…¨ã€‚</li>"); } moonImpactList.innerHTML = tips.join(''); } }
        function updateLifeAdvice() { if (!globalWeatherData || !globalAstronomyData) return; const now = new Date(); const hour = now.getHours(); const weather = globalWeatherData.list[0]; const temp = weather.main.temp; const humidity = weather.main.humidity; const phaseName = (document.getElementById('moon-phase-name').textContent || "").trim(); const dietAdvice = document.getElementById('diet-advice'); const outdoorAdvice = document.getElementById('outdoor-advice'); const healthAdvice = document.getElementById('health-advice'); if(dietAdvice) dietAdvice.innerHTML = `<li>**æ¸…å‡‰é¥®é£Ÿ**: å¤šå–${humidity > 75 ? 'å†¬ç“œæ±¤' : 'æ¤°å­æ°´'}ï¼Œè§£æš‘é˜²æ¹¿ã€‚</li><li>**é£Ÿç‰©ä¿é²œ**: é«˜æ¸©${temp > 30 ? 'æ˜“å˜è´¨' : 'æ­£å¸¸'}ï¼Œæ³¨æ„å†·è—ã€‚</li>`; if(outdoorAdvice) outdoorAdvice.innerHTML = `<li>**æœ€ä½³æ—¶é—´**: ${hour >= 14 && hour < 17 ? 'å½“å‰æ—¶æ®µç‚çƒ­ï¼Œå»ºè®®å‚æ™š' : 'é€‚åˆ'}æ•£æ­¥ã€‚</li><li>**å¿…å¤‡ç‰©å“**: ${temp > 30 ? 'å¤ªé˜³å¸½ã€é˜²æ™’éœœ' : 'è½»ä¾¿è¡£ç‰©'}ã€é¥®ç”¨æ°´ã€‚</li>`; if(healthAdvice) healthAdvice.innerHTML = `<li>æ™šå¤æ¹¿çƒ­ï¼Œ${phaseName === 'ç›ˆå‡¸æœˆ' ? 'ç›ˆå‡¸æœˆå…»é˜´' : 'æœˆç›¸å¹³ç¨³'}ã€‚é¥®é£Ÿæ¸…æ·¡ã€‚</li><li>ä¸‹åˆ2ç‚¹å${hour >= 14 ? 'é¿å…' : 'é€‚åº¦'}æ´»åŠ¨ï¼Œåˆä¼‘å…»å¿ƒã€‚</li><li>ç©´ä½æŒ‰æ‘©ï¼šåˆè°·ç©´æ¸…çƒ­ï¼Œå¤ªå†²ç©´ç–è‚ã€‚</li>`; }

        // --- 4. Helper & Modal Functions ---
        function showImageModal(imageUrl) { const modal = document.getElementById('image-modal'); const modalImage = document.getElementById('modal-image'); if (modal && modalImage) { modalImage.src = imageUrl; modal.style.display = 'flex'; } }
        function hideImageModal() { const modal = document.getElementById('image-modal'); if (modal) { modal.style.display = 'none'; } }
        function getMoonEmoji(phase) { if (phase.includes("New Moon")) return "ğŸŒ‘"; if (phase.includes("Waxing Crescent")) return "ğŸŒ’"; if (phase.includes("First Quarter")) return "ğŸŒ“"; if (phase.includes("Waxing Gibbous")) return "ğŸŒ”"; if (phase.includes("Full Moon")) return "ğŸŒ•"; if (phase.includes("Waning Gibbous")) return "ğŸŒ–"; if (phase.includes("Last Quarter")) return "ğŸŒ—"; if (phase.includes("Waning Crescent")) return "ğŸŒ˜"; return "ğŸŒ™"; }
        function getWeatherIcon(id) { if (id >= 200 && id < 300) return 'â›ˆï¸'; if (id >= 300 && id < 400) return 'ğŸŒ¦ï¸'; if (id >= 500 && id < 600) return 'ğŸŒ§ï¸'; if (id >= 600 && id < 700) return 'â„ï¸'; if (id >= 700 && id < 800) return 'ğŸŒ«ï¸'; if (id === 800) return 'â˜€ï¸'; if (id === 801) return 'ğŸŒ¤ï¸'; if (id === 802) return 'ğŸŒ¥ï¸'; if (id > 802) return 'â˜ï¸'; return 'ğŸŒ¡ï¸'; }
        function updateHealthItem(elementId, value, color) { const item = document.getElementById(elementId); if (!item) return; const circle = item.querySelector('.progress-circle'); const textSpan = item.querySelector('.absolute span'); if (!circle || !textSpan) return; const circumference = 2 * Math.PI * 40; const offset = circumference - (value / 100) * circumference; circle.style.strokeDashoffset = offset; circle.style.stroke = color; textSpan.textContent = `${value}%`; textSpan.style.color = color; }
        async function showLocationModal() { const modal = document.getElementById('location-modal'); if (modal) modal.style.display = 'flex'; populateCountries(); }
        function hideLocationModal() { const modal = document.getElementById('location-modal'); if (modal) modal.style.display = 'none'; }
        async function populateCountries() { const countrySelect = document.getElementById('country-select'); countrySelect.innerHTML = '<option value="">-- é€‰æ‹©å›½å®¶ --</option>'; const { data, error } = await supabase.from('countries').select('name, iso2').order('name'); if (error) { console.error('Error fetching countries:', error); return; } data.forEach(country => { const option = document.createElement('option'); option.value = country.iso2; option.textContent = country.name; countrySelect.appendChild(option); }); }
        async function populateStates(countryCode) { const stateSelect = document.getElementById('state-select'); stateSelect.innerHTML = '<option>æ­£åœ¨åŠ è½½å·/çœ...</option>'; stateSelect.disabled = true; const { data, error } = await supabase.from('states').select('name, id').eq('country_code', countryCode).order('name'); if (error) { console.error('Error fetching states:', error); return; } stateSelect.innerHTML = '<option value="">-- é€‰æ‹©å·/çœ --</option>'; data.forEach(state => { const option = document.createElement('option'); option.value = state.id; option.textContent = state.name; stateSelect.appendChild(option); }); stateSelect.disabled = false; }
        async function populateCities(stateId) { const citySelect = document.getElementById('city-select'); citySelect.innerHTML = '<option>æ­£åœ¨åŠ è½½åŸå¸‚...</option>'; citySelect.disabled = true; const { data, error } = await supabase.from('cities').select('name, latitude, longitude').eq('state_id', stateId).order('name'); if (error) { console.error('Error fetching cities:', error); return; } citySelect.innerHTML = '<option value="">-- é€‰æ‹©åŸå¸‚ --</option>'; data.forEach(city => { const option = document.createElement('option'); option.value = city.name; option.dataset.lat = city.latitude; option.dataset.lon = city.longitude; option.textContent = city.name; citySelect.appendChild(option); }); citySelect.disabled = false; }

        // --- 5. Core UI Interaction ---
        function updateTime() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' }); document.getElementById('current-time').textContent = timeString; const dateString = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' }); document.getElementById('overview-date').textContent = dateString; }
        function nextLayer() { goToLayer((currentLayer % totalLayers) + 1); }
        function prevLayer() { goToLayer(currentLayer === 1 ? totalLayers : currentLayer - 1); }
        function goToLayer(layerNum) { if (layerNum === currentLayer) return; const direction = determineDirection(layerNum); const oldLayer = document.getElementById(`layer-${currentLayer}`); const newLayer = document.getElementById(`layer-${layerNum}`); newLayer.classList.add(`${direction}-in`); requestAnimationFrame(() => { oldLayer.classList.add(`${direction}-out`); oldLayer.classList.remove('active'); newLayer.classList.add('active'); newLayer.classList.remove(`${direction}-in`); }); setTimeout(() => { document.querySelectorAll('.card-layer').forEach(layer => { if (layer.id !== newLayer.id) { layer.className = 'card-layer'; } }); }, 600); updateNav(layerNum); currentLayer = layerNum; triggerEntryAnimations(newLayer); }
        function determineDirection(targetLayer) { if (currentLayer === totalLayers && targetLayer === 1) return 'next'; if (currentLayer === 1 && targetLayer === totalLayers) return 'prev'; return targetLayer > currentLayer ? 'next' : 'prev'; }
        function updateNav(layerNum) { document.querySelectorAll('.nav-dot').forEach(dot => dot.classList.remove('active')); document.querySelector(`.nav-dot[data-layer="${layerNum}"]`).classList.add('active'); document.getElementById('current-layer').textContent = `ç¬¬${layerNum}å±‚`; document.getElementById('layer-title').textContent = layerTitles[layerNum]; }
        function triggerEntryAnimations(container) {
            container.querySelectorAll('[data-anim]').forEach(el => { el.classList.remove('fade-in-up'); void el.offsetWidth; el.classList.add('fade-in-up'); });
            if (container.id === 'layer-4') {
                container.querySelectorAll('.health-item').forEach(item => {
                    const value = parseInt(item.dataset.value, 10) || 0;
                    const color = item.dataset.color || '#6b7280';
                    updateHealthItem(item.id, value, color);
                });
            }
        }

        // --- 6. Page Load & Geolocation ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeWithLocation();
            setInterval(updateTime, 1000);
            updateTime();
            triggerEntryAnimations(document.getElementById('layer-1'));
            document.addEventListener('keydown', e => { if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextLayer(); } else if (e.key === 'ArrowLeft') { e.preventDefault(); prevLayer(); } else if (e.key === 'Home') { e.preventDefault(); goToLayer(1); } else if (e.key === 'End') { e.preventDefault(); goToLayer(totalLayers); } });
            document.addEventListener('touchstart', e => { startX = e.touches[0].clientX; });
            document.addEventListener('touchend', e => { const diffX = startX - e.changedTouches[0].clientX; if (Math.abs(diffX) > 50) { diffX > 0 ? nextLayer() : prevLayer(); } });
            document.getElementById('country-select').addEventListener('change', (e) => { document.getElementById('state-select').innerHTML = '<option>è¯·å…ˆé€‰æ‹©å›½å®¶</option>'; document.getElementById('state-select').disabled = true; document.getElementById('city-select').innerHTML = '<option>è¯·å…ˆé€‰æ‹©å·/çœ</option>'; document.getElementById('city-select').disabled = true; document.getElementById('confirm-location-btn').disabled = true; populateStates(e.target.value); });
            document.getElementById('state-select').addEventListener('change', (e) => { const stateId = e.target.value; document.getElementById('city-select').innerHTML = '<option>è¯·å…ˆé€‰æ‹©å·/çœ</option>'; document.getElementById('city-select').disabled = true; document.getElementById('confirm-location-btn').disabled = true; populateCities(stateId); });
            document.getElementById('city-select').addEventListener('change', (e) => { document.getElementById('confirm-location-btn').disabled = e.target.value === ""; });
            document.getElementById('confirm-location-btn').addEventListener('click', () => { const citySelect = document.getElementById('city-select'); const selectedOption = citySelect.options[citySelect.selectedIndex]; const lat = parseFloat(selectedOption.dataset.lat); const lon = parseFloat(selectedOption.dataset.lon); const cityName = selectedOption.value; document.getElementById('location-display').querySelector('span').textContent = cityName; fetchAllData(lat, lon, DEFAULT_INAT_PLACE_ID); hideLocationModal(); });
        });

        function initializeWithLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        const cityName = await fetchCityName(lat, lon);
                        document.getElementById('location-display').querySelector('span').textContent = cityName;
                        fetchAllData(lat, lon, DEFAULT_INAT_PLACE_ID);
                    },
                    () => {
                        console.log("Geolocation permission denied. Using default location.");
                        document.getElementById('location-display').querySelector('span').textContent = `é©¬æ¥è¥¿äºš Â· ${DEFAULT_CITY}`;
                        fetchAllData(DEFAULT_LAT, DEFAULT_LNG, DEFAULT_INAT_PLACE_ID);
                    }
                );
            } else {
                console.log("Geolocation is not supported. Using default location.");
                document.getElementById('location-display').querySelector('span').textContent = `é©¬æ¥è¥¿äºš Â· ${DEFAULT_CITY}`;
                fetchAllData(DEFAULT_LAT, DEFAULT_LNG, DEFAULT_INAT_PLACE_ID);
            }
        }

        function fetchAllData(lat, lon, placeId) {
            fetchWeatherData(lat, lon);
            fetchAstronomyData(lat, lon);
            fetchAirPollutionData(lat, lon);
            fetchEcologyData(placeId);
            fetchStockData();
            fetchCryptoData();
        }
    </script>
</body>
</html>
